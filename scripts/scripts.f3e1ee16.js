function BaseFigure(a,b){this.figType,this.figColor,this.oldPlace,this.newPlace,this.isUnderAttack=!1,this.isTaken=!1,this.vector=1,this.img,this.init=function(a,b){if(this.figColor=a,this.figType=b,this.figColor==FigureTypes.WHITE)switch(this.figType){case FigureTypes.PESHKA:this.img=FigureTypes.peshka_w_class;break;case FigureTypes.LADIA:this.img=FigureTypes.ladia_w_class;break;case FigureTypes.KON:this.img=FigureTypes.kon_w_class;break;case FigureTypes.SLON:this.img=FigureTypes.slon_w_class;break;case FigureTypes.QUEEN:this.img=FigureTypes.queen_w_class;break;case FigureTypes.KING:this.img=FigureTypes.king_w_class}if(this.figColor==FigureTypes.BLACK)switch(this.figType){case FigureTypes.PESHKA:this.img=FigureTypes.peshka_b_class;break;case FigureTypes.LADIA:this.img=FigureTypes.ladia_b_class;break;case FigureTypes.KON:this.img=FigureTypes.kon_b_class;break;case FigureTypes.SLON:this.img=FigureTypes.slon_b_class;break;case FigureTypes.QUEEN:this.img=FigureTypes.queen_b_class;break;case FigureTypes.KING:this.img=FigureTypes.king_b_class}},this.convert=function(a){this.init(this.figColor,a)},this.init(a,b)}function chessBoardBase(){this.letters=["a","b","c","d","e","f","g","h"],this.numbers=["1","2","3","4","5","6","7","8"],this.cb,this.NameToXY=function(a){var b=a.split("_");return{X:this.letters.indexOf(b[0]),Y:parseInt(b[1]-1)}},this.XYToName=function(a,b){return this.letters[a]+"_"+String(parseInt(b)+1)},this.diag_1=["a_7","b_8"],this.diag_2=["a_6","b_7","c_8"],this.diag_3=["a_5","b_6","c_7","d_8"],this.diag_4=["a_4","b_5","c_6","d_7","e_8"],this.diag_5=["a_3","b_4","c_5","d_6","e_7","f_8"],this.diag_6=["a_2","b_3","c_4","d_5","e_6","f_7","g_8"],this.diag_7=["a_1","b_2","c_3","d_4","e_5","f_6","g_7","h_8"],this.diag_8=["b_1","c_2","d_3","e_4","f_5","g_6","h_7"],this.diag_9=["c_1","d_2","e_3","f_4","g_5","h_6"],this.diag_10=["d_1","e_2","f_3","g_4","h_5"],this.diag_11=["e_1","f_2","g_3","h_4"],this.diag_12=["f_1","g_2","h_3"],this.diag_13=["g_1","h_2"],this.diag_14=["a_2","b_1"],this.diag_15=["a_3","b_2","c_1"],this.diag_16=["a_4","b_3","c_2","d_1"],this.diag_17=["a_5","b_4","c_3","d_2","e_1"],this.diag_18=["a_6","b_5","c_4","d_3","e_2","f_1"],this.diag_19=["a_7","b_6","c_5","d_4","e_3","f_2","g_1"],this.diag_20=["a_8","b_7","c_6","d_5","e_4","f_3","g_2","h_1"],this.diag_21=["b_8","c_7","d_6","e_5","f_4","g_3","h_2"],this.diag_22=["c_8","d_7","e_6","f_5","g_4","h_3"],this.diag_23=["d_8","e_7","f_6","g_5","h_4"],this.diag_24=["e_8","f_7","g_6","h_5"],this.diag_25=["f_8","g_7","h_6"],this.diag_26=["g_8","h_7"],this.hor_1=["a_1","b_1","c_1","d_1","e_1","f_1","g_1","h_1"],this.hor_2=["a_2","b_2","c_2","d_2","e_2","f_2","g_2","h_2"],this.hor_3=["a_3","b_3","c_3","d_3","e_3","f_3","g_3","h_3"],this.hor_4=["a_4","b_4","c_4","d_4","e_4","f_4","g_4","h_4"],this.hor_5=["a_5","b_5","c_5","d_5","e_5","f_5","g_5","h_5"],this.hor_6=["a_6","b_6","c_6","d_6","e_6","f_6","g_6","h_6"],this.hor_7=["a_7","b_7","c_7","d_7","e_7","f_7","g_7","h_7"],this.hor_8=["a_8","b_8","c_8","d_8","e_8","f_8","g_8","h_8"],this.vert_1=["a_1","a_2","a_3","a_4","a_5","a_6","a_7","a_8"],this.vert_2=["b_1","b_2","b_3","b_4","b_5","b_6","b_7","b_8"],this.vert_3=["c_1","c_2","c_3","c_4","c_5","c_6","c_7","c_8"],this.vert_4=["d_1","d_2","d_3","d_4","d_5","d_6","d_7","d_8"],this.vert_5=["e_1","e_2","e_3","e_4","e_5","e_6","e_7","e_8"],this.vert_6=["f_1","f_2","f_3","f_4","f_5","f_6","f_7","f_8"],this.vert_7=["g_1","g_2","g_3","g_4","g_5","g_6","g_7","g_8"],this.vert_8=["h_1","h_2","h_3","h_4","h_5","h_6","h_7","h_8"],this.verts=[this.vert_1,this.vert_2,this.vert_3,this.vert_4,this.vert_5,this.vert_6,this.vert_7,this.vert_8],this.hors=[this.hor_1,this.hor_2,this.hor_3,this.hor_4,this.hor_5,this.hor_6,this.hor_7,this.hor_8],this.diags=[this.diag_1,this.diag_2,this.diag_3,this.diag_4,this.diag_5,this.diag_6,this.diag_7,this.diag_8,this.diag_9,this.diag_10,this.diag_11,this.diag_12,this.diag_13,this.diag_14,this.diag_15,this.diag_16,this.diag_17,this.diag_18,this.diag_19,this.diag_20,this.diag_21,this.diag_22,this.diag_23,this.diag_24,this.diag_25,this.diag_26],this.p_b_0=new BaseFigure(FigureTypes.BLACK,FigureTypes.PESHKA),this.p_b_1=new BaseFigure(FigureTypes.BLACK,FigureTypes.PESHKA),this.p_b_2=new BaseFigure(FigureTypes.BLACK,FigureTypes.PESHKA),this.p_b_3=new BaseFigure(FigureTypes.BLACK,FigureTypes.PESHKA),this.p_b_4=new BaseFigure(FigureTypes.BLACK,FigureTypes.PESHKA),this.p_b_5=new BaseFigure(FigureTypes.BLACK,FigureTypes.PESHKA),this.p_b_6=new BaseFigure(FigureTypes.BLACK,FigureTypes.PESHKA),this.p_b_7=new BaseFigure(FigureTypes.BLACK,FigureTypes.PESHKA),this.l_b_0=new BaseFigure(FigureTypes.BLACK,FigureTypes.LADIA),this.l_b_7=new BaseFigure(FigureTypes.BLACK,FigureTypes.LADIA),this.k_b_1=new BaseFigure(FigureTypes.BLACK,FigureTypes.KON),this.k_b_6=new BaseFigure(FigureTypes.BLACK,FigureTypes.KON),this.s_b_2=new BaseFigure(FigureTypes.BLACK,FigureTypes.SLON),this.s_b_5=new BaseFigure(FigureTypes.BLACK,FigureTypes.SLON),this.q_b_3=new BaseFigure(FigureTypes.BLACK,FigureTypes.QUEEN),this.k_b_4=new BaseFigure(FigureTypes.BLACK,FigureTypes.KING),this.p_w_0=new BaseFigure(FigureTypes.WHITE,FigureTypes.PESHKA),this.p_w_1=new BaseFigure(FigureTypes.WHITE,FigureTypes.PESHKA),this.p_w_2=new BaseFigure(FigureTypes.WHITE,FigureTypes.PESHKA),this.p_w_3=new BaseFigure(FigureTypes.WHITE,FigureTypes.PESHKA),this.p_w_4=new BaseFigure(FigureTypes.WHITE,FigureTypes.PESHKA),this.p_w_5=new BaseFigure(FigureTypes.WHITE,FigureTypes.PESHKA),this.p_w_6=new BaseFigure(FigureTypes.WHITE,FigureTypes.PESHKA),this.p_w_7=new BaseFigure(FigureTypes.WHITE,FigureTypes.PESHKA),this.l_w_0=new BaseFigure(FigureTypes.WHITE,FigureTypes.LADIA),this.l_w_7=new BaseFigure(FigureTypes.WHITE,FigureTypes.LADIA),this.k_w_1=new BaseFigure(FigureTypes.WHITE,FigureTypes.KON),this.k_w_6=new BaseFigure(FigureTypes.WHITE,FigureTypes.KON),this.s_w_2=new BaseFigure(FigureTypes.WHITE,FigureTypes.SLON),this.s_w_5=new BaseFigure(FigureTypes.WHITE,FigureTypes.SLON),this.q_w_3=new BaseFigure(FigureTypes.WHITE,FigureTypes.QUEEN),this.k_w_4=new BaseFigure(FigureTypes.WHITE,FigureTypes.KING),this.black_figs=[this.p_b_0,this.p_b_1,this.p_b_2,this.p_b_3,this.p_b_4,this.p_b_5,this.p_b_6,this.p_b_7,this.l_b_0,this.k_b_1,this.s_b_2,this.q_b_3,this.k_b_4,this.s_b_5,this.k_b_6,this.l_b_7],this.black_places=["h_7","g_7","f_7","e_7","d_7","c_7","b_7","a_7","h_8","g_8","f_8","e_8","d_8","c_8","b_8","a_8"],this.white_figs=[this.p_w_0,this.p_w_1,this.p_w_2,this.p_w_3,this.p_w_4,this.p_w_5,this.p_w_6,this.p_w_7,this.l_w_0,this.k_w_1,this.s_w_2,this.q_w_3,this.k_w_4,this.s_w_5,this.k_w_6,this.l_w_7],this.white_places=["a_2","b_2","c_2","d_2","e_2","f_2","g_2","h_2","a_1","b_1","c_1","d_1","e_1","f_1","g_1","h_1"],this.arrFigures=[],this.takenFigures=[],this.map_board={},this.cells,this.resinfo={},this.resinfo[FigureTypes.END_CANCEL_W]=["Игрок вышел","Player gone"],this.resinfo[FigureTypes.END_CANCEL_B]=["Игрок вышел","Player gone"],this.resinfo[FigureTypes.END_CANCEL_AND_FAIL_W]=["Игрок сдался","Player gave up"],this.resinfo[FigureTypes.END_CANCEL_AND_FAIL_B]=["Игрок сдался","Player gave up"],this.resinfo[FigureTypes.END_GONE_W]=["Игрок вышел (защитано поражение)","Player gone defeated"],this.resinfo[FigureTypes.END_GONE_B]=["Игрок вышел (защитано поражение)","Player gone defeated"],this.resinfo[FigureTypes.END_TIME_L_W]=["Время на ход вышло.","Step time over"],this.resinfo[FigureTypes.END_TIME_L_B]=["Время на ход вышло.","Step time over"],this.resinfo[FigureTypes.END_TIME_G_W]=["Время вышло.","Time over"],this.resinfo[FigureTypes.END_TIME_G_B]=["Время вышло.","Time over"],this.resinfo[FigureTypes.END_WIN_W]=["Победа белых","White win"],this.resinfo[FigureTypes.END_WIN_B]=["Победа черных","Black win"],this.resinfo[FigureTypes.END_PAT_AGREED]=["Пат по договоренности","Pat agreed"],this.resinfo[FigureTypes.END_PAT]=["Пат","Pat"],this.resinfo[FigureTypes.END_TIME_G_CANCEL]=["Время вышло. Игра не состоялась","Time over. Game canceled"],this.resinfo[FigureTypes.END_TIME_L_CANCEL]=["Время вышло. Игра не состоялась","Time over. Game canceled"],this.InitVectors=function(){for(var a=["a","b","c","d","e","f","g","h"],b=["1","2","3","4","5","6","7","8"],c=0;c<a.length;c++)for(var d=0;d<b.length;d++){var e=this.cells[a[c]+"_"+b[d]];e.vpw=1,e.vpb=-1,e.vpr=-1}this.cells.a_2.paw=["b_3"],this.cells.b_2.paw=["a_3","c_3"],this.cells.c_2.paw=["b_3","d_3"],this.cells.d_2.paw=["c_3","e_3"],this.cells.e_2.paw=["d_3","f_3"],this.cells.f_2.paw=["e_3","g_3"],this.cells.g_2.paw=["f_3","h_3"],this.cells.h_2.paw=["g_3"],this.cells.a_3.paw=["b_4"],this.cells.b_3.paw=["a_4","c_4"],this.cells.c_3.paw=["b_4","d_4"],this.cells.d_3.paw=["c_4","e_4"],this.cells.e_3.paw=["d_4","f_4"],this.cells.f_3.paw=["e_4","g_4"],this.cells.g_3.paw=["f_4","h_4"],this.cells.h_3.paw=["g_4"],this.cells.a_4.paw=["b_5"],this.cells.b_4.paw=["a_5","c_5"],this.cells.c_4.paw=["b_5","d_5"],this.cells.d_4.paw=["c_5","e_5"],this.cells.e_4.paw=["d_5","f_5"],this.cells.f_4.paw=["e_5","g_5"],this.cells.g_4.paw=["f_5","h_5"],this.cells.h_4.paw=["g_5"],this.cells.a_5.paw=["b_6"],this.cells.b_5.paw=["a_6","c_6"],this.cells.c_5.paw=["b_6","d_6"],this.cells.d_5.paw=["c_6","e_6"],this.cells.e_5.paw=["d_6","f_6"],this.cells.f_5.paw=["e_6","g_6"],this.cells.g_5.paw=["f_6","h_6"],this.cells.h_5.paw=["g_6"],this.cells.a_6.paw=["b_7"],this.cells.b_6.paw=["a_7","c_7"],this.cells.c_6.paw=["b_7","d_7"],this.cells.d_6.paw=["c_7","e_7"],this.cells.e_6.paw=["d_7","f_7"],this.cells.f_6.paw=["e_7","g_7"],this.cells.g_6.paw=["f_7","h_7"],this.cells.h_6.paw=["g_7"],this.cells.a_7.paw=["b_8"],this.cells.b_7.paw=["a_8","c_8"],this.cells.c_7.paw=["b_8","d_8"],this.cells.d_7.paw=["c_8","e_8"],this.cells.e_7.paw=["d_8","f_8"],this.cells.f_7.paw=["e_8","g_8"],this.cells.g_7.paw=["f_8","h_8"],this.cells.h_7.paw=["g_8"],this.cells,this.cells.h_7.pab=["g_6"],this.cells.g_7.pab=["h_6","f_6"],this.cells.f_7.pab=["g_6","e_6"],this.cells.e_7.pab=["f_6","d_6"],this.cells.d_7.pab=["e_6","c_6"],this.cells.c_7.pab=["d_6","b_6"],this.cells.b_7.pab=["c_6","a_6"],this.cells.a_7.pab=["b_6"],this.cells.h_6.pab=["g_5"],this.cells.g_6.pab=["h_5","f_5"],this.cells.f_6.pab=["g_5","e_5"],this.cells.e_6.pab=["f_5","d_5"],this.cells.d_6.pab=["e_5","c_5"],this.cells.c_6.pab=["d_5","b_5"],this.cells.b_6.pab=["c_5","a_5"],this.cells.a_6.pab=["b_5"],this.cells.h_5.pab=["g_4"],this.cells.g_5.pab=["h_4","f_4"],this.cells.f_5.pab=["g_4","e_4"],this.cells.e_5.pab=["f_4","d_4"],this.cells.d_5.pab=["e_4","c_4"],this.cells.c_5.pab=["d_4","b_4"],this.cells.b_5.pab=["c_4","a_4"],this.cells.a_5.pab=["b_4"],this.cells.h_4.pab=["g_3"],this.cells.g_4.pab=["h_3","f_3"],this.cells.f_4.pab=["g_3","e_3"],this.cells.e_4.pab=["f_3","d_3"],this.cells.d_4.pab=["e_3","c_3"],this.cells.c_4.pab=["d_3","b_3"],this.cells.b_4.pab=["c_3","a_3"],this.cells.a_4.pab=["b_3"],this.cells.h_3.pab=["g_2"],this.cells.g_3.pab=["h_2","f_2"],this.cells.f_3.pab=["g_2","e_2"],this.cells.e_3.pab=["f_2","d_2"],this.cells.d_3.pab=["e_2","c_2"],this.cells.c_3.pab=["d_2","b_2"],this.cells.b_3.pab=["c_2","a_2"],this.cells.a_3.pab=["b_2"],this.cells.h_2.pab=["g_1"],this.cells.g_2.pab=["h_1","f_1"],this.cells.f_2.pab=["g_1","e_1"],this.cells.e_2.pab=["f_1","d_1"],this.cells.d_2.pab=["e_1","c_1"],this.cells.c_2.pab=["d_1","b_1"],this.cells.b_2.pab=["c_1","a_1"],this.cells.a_2.pab=["b_1"]},this.vvect=function(a){switch(a.fig.figColor){case FigureTypes.WHITE:return a.vpw;case FigureTypes.BLACK:return a.vpb;case FigureTypes.RED:return a.vpr}return 0},this.attackVectors=function(a){switch(a.fig.figColor){case FigureTypes.WHITE:return a.paw;case FigureTypes.BLACK:return a.pab;case FigureTypes.RED:return a.par}return[]},this.initBoardCells=function(){for(var a=0,b={},c=0;8>c;c++){for(var d=0;8>d;d++){var e=this.letters[d]+"_"+this.numbers[7-c];b[e]=new ChessCell({col:a%2==0?1:0,name:e}),a++}a++}return this.cells=b,b},this.initChessBoard=function(a,b){var c=[[],[],[],[],[],[],[],[]];for(l=0;l<this.letters.length;l++)for(var d=0;d<this.numbers.length;d++){var e=1==b?this.letters[l]+"_"+this.numbers[7-d]:this.letters[7-l]+"_"+this.numbers[d];c[d][l]=a[e]}return c},this.initFigures=function(a,b){for(i=0;i<this.black_figs.length;i++)this.cells[this.black_places[i]].setFig(this.black_figs[i]);for(i=0;i<this.white_figs.length;i++)this.cells[this.white_places[i]].setFig(this.white_figs[i]);this.InitVectors(),this.arrFigures=this.black_figs.concat(this.white_figs),this.playgroundParams=a,this.cb=b,this.myColor=a.myColor},this.typesMap=[FigureTypes.PESHKA,FigureTypes.LADIA,FigureTypes.KON,FigureTypes.SLON,FigureTypes.QUEEN,FigureTypes.KING],this.boardToString=function(){var a,b=[];for(a=0;a<this.arrFigures.length;a++){var c=this.NameToXY(this.arrFigures[a].oldPlace),d=parseInt(c.X<<4)|parseInt(c.Y),e=parseInt(1==this.arrFigures[a].isTaken?1:0)<<4|parseInt(this.typesMap.indexOf(this.arrFigures[a].figType));b.push((d<<8|e).toString(16))}return b.join(",")},this.arrangeFigures=function(a){var b,c,d,e,f,g,h=a.split(",");for(var i in this.cells)this.cells[i].fig=null;for(var j=0;j<this.arrFigures.length;j++){var k=parseInt(h[j],16);b=k>>8&255,e=255&k,d=15&b,c=b>>4&15,f=e>>4&15,g=15&e,this.arrFigures[6*parseInt(j/16)+g]?(this.arrFigures[j].figType!=this.typesMap[g]&&this.arrFigures[j].convert(this.typesMap[g]),this.arrFigures[j].oldPlace=this.XYToName(c,d),this.arrFigures[j].isTaken=0==f?!1:!0,f?-1==this.takenFigures.indexOf(j)&&(this.takenFigures.push(j),this.cb&&this.cb("taken",{figType:this.arrFigures[j].figType,figColor:this.arrFigures[j].figColor,index:j})):this.cells[this.arrFigures[j].oldPlace].setFig(this.arrFigures[j])):console.log("type not found",6*parseInt(j/16)+g)}},this.myColor="white",this.old_place,this.isDragging,this.takeOnPassStep,this.playgroundParams,this.deselectBoard=function(){for(var a=0;a<this.letters.length;a++)for(var b=0;b<this.numbers.length;b++)this.cells[this.letters[a]+"_"+this.numbers[b]].isBlue=!1,this.cells[this.letters[a]+"_"+this.numbers[b]].isGreen=!1,this.cells[this.letters[a]+"_"+this.numbers[b]].oldMarker=!1},this.otherKingPoses=function(){var a=[];for(var b in this.cells){var c=this.cells[b];null!=c.fig&&c.fig.figColor!=this.myColor&&c.fig.figType==FigureTypes.KING&&a.push(c.name)}return a},this.myKingPos=function(){for(var a in this.cells){var b=this.cells[a];if(null!=b.fig&&b.fig.figColor==this.myColor&&b.fig.figType==FigureTypes.KING)return b.name}return""},this.getVertAttacks=function(a){for(var b,c,d=[],e=0;e<this.verts.length;e++){var f=this.verts[e].indexOf(a);if(f>=0){for(c=f+1;c<this.verts[e].length;c++)if(b=this.cells[this.verts[e][c]],null!=b.fig){d.push(this.verts[e][c]);break}for(c=f-1;c>=0;c--)if(b=this.cells[this.verts[e][c]],null!=b.fig){d.push(this.verts[e][c]);break}}}return d},this.getHorAttacks=function(a){for(var b,c,d=[],e=0;e<this.hors.length;e++){var f=this.hors[e].indexOf(a);if(f>=0){for(c=f+1;c<this.hors[e].length;c++)if(b=this.cells[this.hors[e][c]],null!=b.fig){d.push(this.hors[e][c]);break}for(c=f-1;c>=0;c--)if(b=this.cells[this.hors[e][c]],null!=b.fig){d.push(this.hors[e][c]);break}}}return d},this.getDiagAttacks=function(a){for(var b,c,d=[],e=0;e<this.diags.length;e++){var f=this.diags[e].indexOf(a);if(f>=0){for(c=f+1;c<this.diags[e].length;c++)if(b=this.cells[this.diags[e][c]],null!=b.fig){d.push(this.diags[e][c]);break}for(c=f-1;c>=0;c--)if(b=this.cells[this.diags[e][c]],null!=b.fig){d.push(this.diags[e][c]);break}}}return d},this.cellBitten=function(a,b){var c,d,e,f=!1,g=this.getVertAttacks(a),h=this.getHorAttacks(a),i=this.getDiagAttacks(a),j=this.getKonSteps(a),k="";if(j.length>0)for(stepKey in j){var k=j[stepKey];if(d=this.cells[k],c=d.fig,null!=c&&c.figColor!=b&&c.figType==FigureTypes.KON)return!0}if(i.length>0)for(stepKey in i){var k=i[stepKey];if(d=this.cells[k],c=d.fig,null!=c&&c.figColor!=b)if(c.figType==FigureTypes.PESHKA){if(e=this.attackVectors(d),e.indexOf(a)>=0)return!0}else if(c.figType==FigureTypes.SLON||c.figType==FigureTypes.QUEEN)return!0}if(g.length+h.length>0){var l=g.concat(h);for(stepKey in l){var k=l[stepKey];if(d=this.cells[k],c=d.fig,null!=c&&c.figColor!=b&&(c.figType==FigureTypes.LADIA||c.figType==FigureTypes.QUEEN))return!0}}return f},this.inVerts=function(a){var b=[],c=this.cells[a],d=0;if(!c.fig)return[];var e,f,g,h=a.split("_");for(f=0;f<this.verts.length;f++){var i=this.verts[f].indexOf(a);if(i>=0){if(c.fig.figType==FigureTypes.PESHKA){if(d=this.vvect(c),e=this.cells[this.verts[f][i+d]],e&&null==e.fig){b.push(this.verts[f][i+d]);var j=!1;(this.myColor==FigureTypes.WHITE&&"2"==h[1]||this.myColor==FigureTypes.BLACK&&"7"==h[1])&&(j=!0),this.cells[this.verts[f][i+2*d]]&&j&&null==this.cells[this.verts[f][i+2*d]].fig&&b.push(this.verts[f][i+2*d])}var k=this.attackVectors(c);for(var l in k){var m=k[l],n=this.playgroundParams.lastStep.split(":"),o=n[0].split("_"),p=n[1].split("_"),q=m.split("_");this.myColor==FigureTypes.WHITE?"7"==o[1]&&"5"==p[1]&&"5"==h[1]&&o[0]==q[0]&&(this.takeOnPassStep=m,b.push(m)):"2"==o[1]&&"4"==p[1]&&"4"==h[1]&&o[0]==q[0]&&(this.takeOnPassStep=m,b.push(m)),null!=this.cells[m].fig&&this.cells[m].fig.figColor!=c.fig.figColor&&b.push(m)}return b}for(g=i+1;g<this.verts[f].length;g++){if(e=this.cells[this.verts[f][g]],null!=e.fig){e.fig.figColor!=c.fig.figColor&&b.push(this.verts[f][g]);break}if(b.push(this.verts[f][g]),c.fig.figType==FigureTypes.KING)break}for(g=i-1;g>=0;g--){if(e=this.cells[this.verts[f][g]],null!=e.fig){e.fig.figColor!=c.fig.figColor&&b.push(this.verts[f][g]);break}if(b.push(this.verts[f][g]),c.fig.figType==FigureTypes.KING)break}}}return b},this.inHors=function(a){for(var b,c,d=[],e=this.cells[a].fig,f=0;f<this.hors.length;f++){var g=this.hors[f].indexOf(a);if(g>=0){for(c=g+1;c<this.hors[f].length;c++){if(b=this.cells[this.hors[f][c]],null!=b.fig){b.fig.figColor!=e.figColor&&d.push(this.hors[f][c]);break}if(d.push(this.hors[f][c]),e.figType==FigureTypes.KING)break}for(c=g-1;c>=0;c--){if(b=this.cells[this.hors[f][c]],null!=b.fig){b.fig.figColor!=e.figColor&&d.push(this.hors[f][c]);break}if(d.push(this.hors[f][c]),e.figType==FigureTypes.KING)break}}}return d},this.inDiags=function(a){var b=[],c=this.cells[a].fig;if(!c)return[];for(var d,e,f=0;f<this.diags.length;f++){var g=this.diags[f].indexOf(a);if(g>=0){for(e=g+1;e<this.diags[f].length;e++){if(d=this.cells[this.diags[f][e]],null!=d.fig){d.fig.figColor!=c.figColor&&b.push(this.diags[f][e]);break}if(b.push(this.diags[f][e]),c.figType==FigureTypes.KING)break}for(e=g-1;e>=0;e--){if(d=this.cells[this.diags[f][e]],null!=d.fig){d.fig.figColor!=c.figColor&&b.push(this.diags[f][e]);break}if(b.push(this.diags[f][e]),c.figType==FigureTypes.KING)break}}}return b},this.getKingSteps=function(a){var b,c,d,e=[],f=this.cells[a].fig;for(c=0;c<this.diags.length;c++)d=this.diags[c].indexOf(a),d>=0&&(b=this.cells[this.diags[c][d+1]],b&&null!=b.fig?b.fig.figColor!=f.figColor&&e.push(this.diags[c][d+1]):b&&e.push(this.diags[c][d+1]),b=this.cells[this.diags[c][d-1]],b&&null!=b.fig?b.fig.figColor!=f.figColor&&e.push(this.diags[c][d-1]):b&&e.push(this.diags[c][d-1]));for(c=0;c<this.hors.length;c++)d=this.hors[c].indexOf(a),d>=0&&(b=this.cells[this.hors[c][d+1]],b&&null!=b.fig?b.fig.figColor!=f.figColor&&e.push(this.hors[c][d+1]):b&&e.push(this.hors[c][d+1]),b=this.cells[this.hors[c][d-1]],b&&null!=b.fig?b.fig.figColor!=f.figColor&&e.push(this.hors[c][d-1]):b&&e.push(this.hors[c][d-1]));for(c=0;c<this.verts.length;c++)d=this.verts[c].indexOf(a),d>=0&&(b=this.cells[this.verts[c][d+1]],b&&null!=b.fig?b.fig.figColor!=f.figColor&&e.push(this.verts[c][d+1]):b&&e.push(this.verts[c][d+1]),b=this.cells[this.verts[c][d-1]],b&&null!=b.fig?b.fig.figColor!=f.figColor&&e.push(this.verts[c][d-1]):b&&e.push(this.verts[c][d-1]));return e},this.inKons=function(a){var b,c=[],d=this.getKonSteps(a),e=this.cells[a].fig;for(var f in d){var g=d[f];b=this.cells[g],b&&(null!=b.fig?b.fig.figColor!=e.figColor&&c.push(g):c.push(g))}return c},this.getKonSteps=function(a){var b,c,d,e,f,g=[],h="",i="";for(b=0;b<this.hors.length;b++)if(d=this.hors[b].indexOf(a),d>=0)for(this.hors[b][d-2]&&(h=this.hors[b][d-2]),this.hors[b][d+2]&&(i=this.hors[b][d+2]),c=0;c<this.verts.length;c++)e=this.verts[c].indexOf(h),f=this.verts[c].indexOf(i),(e>=0||f>=0)&&(e>=0&&(this.verts[c][e-1]&&g.push(this.verts[c][e-1]),this.verts[c][e+1]&&g.push(this.verts[c][e+1])),f>=0&&(this.verts[c][f-1]&&g.push(this.verts[c][f-1]),this.verts[c][f+1]&&g.push(this.verts[c][f+1])));for(h="",i="",b=0;b<this.verts.length;b++)if(d=this.verts[b].indexOf(a),d>=0)for(this.verts[b][d-2]&&(h=this.verts[b][d-2]),this.verts[b][d+2]&&(i=this.verts[b][d+2]),c=0;c<this.hors.length;c++)e=this.hors[c].indexOf(h),f=this.hors[c].indexOf(i),(e>=0||f>=0)&&(e>=0&&(this.hors[c][e-1]&&g.push(this.hors[c][e-1]),this.hors[c][e+1]&&g.push(this.hors[c][e+1])),f>=0&&(this.hors[c][f-1]&&g.push(this.hors[c][f-1]),this.hors[c][f+1]&&g.push(this.hors[c][f+1])));return g},this.checkTwoKings=function(){for(var a=0;a<this.letters.length;a++)for(var b=0;b<this.numbers.length;b++)if(null!=this.cells[this.letters[a]+"_"+this.numbers[b]].fig&&this.cells[this.letters[a]+"_"+this.numbers[b]].fig.figType!=FigureTypes.KING)return!1;return!0},this.cellOldMarker=function(a){var b=this.cells[a];b.oldMarker=!0},this.cellClick=function(a){if(this.playgroundParams.isMyTurn){var b=this.cells[a.name],c=this.cells[this.old_place];if(this.old_place!=a.name&&(this.isDragging||b.fig)&&(null==b.fig||b.isBlue||this.myColor==b.fig.figColor))if(this.isDragging&&null!=b.fig&&null!=c.fig&&b.fig.figColor==c.fig.figColor&&(this.isDragging=!1),!b.isBlue&&c&&(this.deselectBoard(),this.old_place="",this.isDragging=!1),this.isDragging){var d,e=b.fig,f=c.fig,g=this.playgroundParams.lastStep.split(":");if(a.name==this.takeOnPassStep&&(d=this.cells[g[1]].fig,this.cells[g[1]].setFig(null)),f.figType==FigureTypes.KING){if(this.myColor==FigureTypes.WHITE&&"e_1"==this.old_place){if("g_1"==a.name){if(this.cellBitten("e_1",FigureTypes.WHITE)||this.cellBitten("f_1",FigureTypes.WHITE)||this.cellBitten("g_1",FigureTypes.WHITE))return void console.log("dispatchEvent(new DataEventCustom(DataEventCustom.KING_BITTEN, {}));");this.cells.f_1.setFig(this.cells.h_1.fig),this.cells.h_1.setFig(null)}if("c_1"==a.name){if(this.cellBitten("e_1",FigureTypes.WHITE)||this.cellBitten("d_1",FigureTypes.WHITE)||this.cellBitten("c_1",FigureTypes.WHITE))return void console.log("dispatchEvent(new DataEventCustom(DataEventCustom.KING_BITTEN, {}));");this.cells.d_1.setFig(this.cells.a_1.fig),this.cells.a_1.setFig(null)}}if(this.myColor==FigureTypes.BLACK&&"e_8"==this.old_place){if("g_8"==a.name){if(this.cellBitten("e_8",FigureTypes.BLACK)||this.cellBitten("f_8",FigureTypes.BLACK)||this.cellBitten("g_8",FigureTypes.BLACK))return void console.log("dispatchEvent(new DataEventCustom(DataEventCustom.KING_BITTEN, {}));");this.cells.f_8.setFig(this.cells.h_8.fig),this.cells.h_8.setFig(null)}if("c_8"==a.name){if(this.cellBitten("e_8",FigureTypes.BLACK)||this.cellBitten("d_8",FigureTypes.BLACK)||this.cellBitten("c_8",FigureTypes.BLACK))return void console.log("dispatchEvent(new DataEventCustom(DataEventCustom.KING_BITTEN, {}));");this.cells.d_8.setFig(this.cells.a_8.fig),this.cells.a_8.setFig(null)}}}b.setFig(c.fig),c.setFig(null);var h=this.otherKingPoses(),i=this.NameToXY(this.myKingPos()),j=!1;for(var k in h){var l=h[k],m=this.NameToXY(l);Math.round(Math.abs(m.X-i.X))<2&&Math.round(Math.abs(m.Y-i.Y))<2&&(j=!0)}if(this.cellBitten(this.myKingPos(),this.myColor)||j)return b.setFig(e),c.setFig(f),console.log("Check"),a.name==this.takeOnPassStep&&(trace("taking on pass roll back"),this.cells[g[1]].setFig(d)),void console.log("dispatchEvent(new DataEventCustom(DataEventCustom.KING_BITTEN, {}));");if(null!=e){e.isTaken=!0;var n=this.arrFigures.indexOf(e);-1!=n&&-1==this.takenFigures.indexOf(n)&&(this.takenFigures.push(n),this.cb("taken",{figType:e.figType,figColor:e.figColor}))}if(a.name==this.takeOnPassStep){d.isTaken=!0;var n=this.arrFigures.indexOf(d);-1!=n&&-1==this.takenFigures.indexOf(n)&&(this.takenFigures.push(n),this.cb("taken",{figType:d.figType,figColor:d.figColor}))}if(this.deselectBoard(),this.isDragging=!1,this.playgroundParams.lastStep=c.name+":"+b.name,this.playgroundParams.myColorConst==FigureTypes.WHITE)switch(c.name){case"e_1":this.playgroundParams.cantRocker.push("e_1");break;case"a_1":this.playgroundParams.cantRocker.push("a_1");break;case"h_1":this.playgroundParams.cantRocker.push("h_1")}else switch(c.name){case"e_8":this.playgroundParams.cantRocker.push("e_8");break;case"a_8":this.playgroundParams.cantRocker.push("a_8");break;case"h_8":this.playgroundParams.cantRocker.push("h_8")}this.cb("history",{fig:f,step:c.name+":"+b.name,color:f.figColor,type:f.figType})}else if(!this.isDragging&&null!=b.fig){this.old_place=a.name,c=this.cells[this.old_place],this.myColor=c.fig.figColor,this.isDragging=!0,this.deselectBoard(),this.takeOnPassStep="";var o=[];switch(c.fig.figType){case FigureTypes.PESHKA:o=o.concat(this.inVerts(this.old_place));break;case FigureTypes.LADIA:o=o.concat(this.inHors(this.old_place)),o=o.concat(this.inVerts(this.old_place));break;case FigureTypes.KON:o=o.concat(this.inKons(this.old_place));break;case FigureTypes.SLON:o=o.concat(this.inDiags(this.old_place));break;case FigureTypes.KING:o=o.concat(this.inVerts(this.old_place)),o=o.concat(this.inHors(this.old_place)),o=o.concat(this.inDiags(this.old_place)),this.myColor==FigureTypes.WHITE&&"e_1"==a.name&&-1==this.playgroundParams.cantRocker.indexOf(a.name)&&(-1==this.playgroundParams.cantRocker.indexOf("h_1")&&null==this.cells.f_1.fig&&null==this.cells.g_1.fig&&o.push("g_1"),-1==this.playgroundParams.cantRocker.indexOf("a_1")&&null==this.cells.b_1.fig&&null==this.cells.c_1.fig&&null==this.cells.d_1.fig&&o.push("c_1")),this.myColor==FigureTypes.BLACK&&"e_8"==a.name&&-1==this.playgroundParams.cantRocker.indexOf(a.name)&&(-1==this.playgroundParams.cantRocker.indexOf("h_8")&&null==this.cells.f_8.fig&&null==this.cells.g_8.fig&&o.push("g_8"),-1==this.playgroundParams.cantRocker.indexOf("a_8")&&null==this.cells.b_8.fig&&null==this.cells.c_8.fig&&null==this.cells.d_8.fig&&o.push("c_8"));break;case FigureTypes.QUEEN:o=o.concat(this.inVerts(this.old_place)),o=o.concat(this.inHors(this.old_place)),o=o.concat(this.inDiags(this.old_place))}if(o.length>0)for(var p in o){var q=o[p];this.cells[q].isBlue=!0}}}},this.swapMy=function(){this.myColor=this.myColor==FigureTypes.WHITE?FigureTypes.BLACK:FigureTypes.WHITE},this.gameCondition=function(){var a,b=this.otherKingPoses(),c=-1;for(var d in b){var e,f,a=b[d],g=this.cellBitten(a,this.cells[a].fig.figColor),h=!1,i=this.cells[a].fig.figColor,j=this.getKingSteps(a);for(var k in j){var l=j[k];e=this.cells[l],f=this.cells[a];var m=this.NameToXY(this.myKingPos()),n=this.NameToXY(l);if(!(Math.round(Math.abs(m.X-n.X))<2&&Math.round(Math.abs(m.Y-n.Y))<2))if(e.fig){if(s=e.fig,e.setFig(f.fig),f.setFig(null),!this.cellBitten(l,i)){h=!0,f.setFig(e.fig),e.setFig(s),console.log("canStep",l);break}f.setFig(e.fig),e.setFig(s)}else{if(e.setFig(f.fig),f.setFig(null),!this.cellBitten(l,i)){h=!0,f.setFig(e.fig),e.setFig(null);break}f.setFig(e.fig),e.setFig(null)}}if(!h){var o,p=[];for(var q in this.cells){var r=this.cells[q];if(null!=r.fig&&r.fig.figColor==this.cells[a].fig.figColor){switch(o=r.name,p=[],r.fig.figType){case FigureTypes.PESHKA:p=p.concat(this.inVerts(o));break;case FigureTypes.LADIA:p=p.concat(this.inHors(o)),p=p.concat(this.inVerts(o));break;case FigureTypes.KON:p=p.concat(this.inKons(o));break;case FigureTypes.SLON:p=p.concat(this.inDiags(o));break;case FigureTypes.KING:break;case FigureTypes.QUEEN:p=p.concat(this.inVerts(o)),p=p.concat(this.inHors(o)),p=p.concat(this.inDiags(o))}var s;if(p.length>0)for(var t in p){var u=p[t];if(e=this.cells[u],f=this.cells[o],e.fig){if(s=e.fig,e.setFig(f.fig),f.setFig(null),!this.cellBitten(a,i)){h=!0,f.setFig(e.fig),e.setFig(s);break}f.setFig(e.fig),e.setFig(s)}else{if(e.setFig(f.fig),f.setFig(null),!this.cellBitten(a,i)){h=!0,f.setFig(e.fig),e.setFig(null);break}f.setFig(e.fig),e.setFig(null)}}if(h)break}}}h?g&&this.cb("check"):(!h&&g&&(console.log("dispatchEvent(new DataEventCustom(DataEventCustom.MAT, { color: this.cells[kpos].fig.figColor } ))"),c=1),h||g||(console.log("dispatchEvent(new DataEventCustom(DataEventCustom.PAT, { } ))"),c=2))}return this.checkTwoKings()&&(console.log("dispatchEvent(new DataEventCustom(DataEventCustom.PAT, { } ))"),c=2),c}}function chessHistory(){this.append=function(a,b,c){var d=c.split(":").join("-");d=d.split("_").join("");var e="";return e=a!=FigureTypes.KING||"e_1:g_1"!=c&&"e_8:g_8"!=c?a!=FigureTypes.KING||"e_1:c_1"!=c&&"e_8:c_8"!=c?this.getFigName(a)+d:"0-0-0":"0-0"},this.getFigName=function(a){switch(a){case FigureTypes.KING:return"Кр";case FigureTypes.QUEEN:return"Ф";case FigureTypes.SLON:return"С";case FigureTypes.KON:return"К";case FigureTypes.LADIA:return"Л";case FigureTypes.PESHKA:return""}return"?"}}function ChessCell(a){this.col=a.col,this.name=a.name,this.fig=null,this.paw=[],this.pab=[],this.setFig=function(a){this.fig=a,a&&(a.name=this.name,a.oldPlace=this.name)}}function pad(a){return 9>=a&&(a="0"+a),a}function msToTime(a){var b=a%60;a=(a-b)/60;var c=a%60;return pad(c)+":"+pad(b)}function BufferLoader(a,b,c){this.context=a,this.urlList=b,this.onload=c,this.bufferList=new Array,this.loadCount=0}FigureTypes={PESHKA:"peshka",SLON:"slon",KON:"kon",LADIA:"ladia",KING:"king",QUEEN:"queen",BLACK:"black",WHITE:"white",RED:"red",WHITE2:"white",W_VECT:1,B_VECT:-1,R_VECT:-1,END_CANCEL_W:1,END_CANCEL_B:2,END_CANCEL_AND_FAIL_W:3,END_CANCEL_AND_FAIL_B:4,END_GONE_W:5,END_GONE_B:6,END_TIME_L_W:7,END_TIME_L_B:8,END_TIME_G_W:9,END_TIME_G_B:10,END_WIN_W:11,END_WIN_B:12,END_PAT_AGREED:13,END_PAT:14,END_TIME_G_CANCEL:15,END_TIME_L_CANCEL:16,peshka_b_class:"./img/figs/peshka_b_flat.png",ladia_b_class:"./img/figs/ladia_b_flat.png",kon_b_class:"./img/figs/kon_b_flat.png",slon_b_class:"./img/figs/slon_b_flat.png",queen_b_class:"./img/figs/queen_b_flat.png",king_b_class:"./img/figs/king_b_flat.png",peshka_w_class:"./img/figs/peshka_w_flat.png",ladia_w_class:"./img/figs/ladia_w_flat.png",kon_w_class:"./img/figs/kon_w_flat.png",slon_w_class:"./img/figs/slon_w_flat.png",queen_w_class:"./img/figs/queen_w_flat.png",king_w_class:"./img/figs/king_w_flat.png"},window.onresize=function(a){var b=($(".ch").width()-30)/8,c=55;b>=79.38&&(b=79.38),b>c?$(".ch .cell-container").css("min-height",b+"px"):$(".ch .cell-container").css("min-height",c+"px")};var server_config={},global_scope={},sndFail,sndStep1,sndStep2,sndTap;angular.module("siteApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","btford.socket-io","ui-rangeSlider"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/lobby.html",controller:"LobbyCtrl",controllerAs:"main"}).when("/lobby",{templateUrl:"views/lobby.html",controller:"LobbyCtrl",controllerAs:"lobby"}).when("/playground",{templateUrl:"views/playground.html",controller:"PlaygroundCtrl",controllerAs:"playground"}).when("/terms",{templateUrl:"views/terms.html",controller:"TermsCtrl",controllerAs:"terms"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]).run(["$rootScope","$location","$route","$window","gameService",function(a,b,c,d,e){a.$on("$locationChangeStart",function(b,c,d){var f=e.getData();-1!=d.indexOf("playground")&&f&&f.user1&&f.user2&&0==e.isFinished&&(a.ConfirmGameExit(),b.preventDefault())})}]);var t=(new Date).getTime();$.ajax({url:"api/config.json?t="+t,success:function(a){$.extend(server_config,a),angular.element(document).ready(function(){angular.bootstrap(document,["siteApp"])})}});var constants={INVITING:2,FREE:3,INVITED:1,PLAYING:4,WATCHING:5,AUTO_PLAY:6,TURNIR:7},dict_words={invite:["пригласить","invite"],Invite:["Пригласить","Invite"],invited:["играем?","let's play?"],Play:["Играть","Play"],Rejection:["Отказаться","No thanks"],Close:["Закрыть","Close"],players_online:["Всего игроков","Players online"],Playing:["Играют","Playing"],playing:["играет","playing..."],YouInvited:["Вас приглашают","You are invited"],welcome:["присоедиился","welocme"],
Player:["игрок","player"],Game_time:["Время игры","Total time"],Step_time:["Время на ход","Step time limit"],Color:["Цвет","Color"],no:["нет","no limit"],Black:["Черными","Black"],White:["Белыми","White"],InviteMode:["Режим приглашения","Invite mode"],InviteAll:["Всех готовых играть","Invite to all"],InviteAllComment:["Приглашение будет отослано всем игрокам","Will be sent to everyone who is not playing"],InviteTo:["Персональное приглашение","Personal invite"],ModeNotSelected:["Не выбран режим приглашения","Invite mode not selected"],SendToAll:["Отправить всем","Send to all"],wait:["ход соперника...","wait ..."],Step_limit:["Лимит на ход","step time rest"],Your_turn:["Ваш ход","Your turn"],Pat:["Ничья","Draw"],Lose:["Сдаться","Lose"],Send:["Отправить","Send"],Check:["Шах","Check"],Convert_p:["Превратить пешку в","Convert to"],Convert:["Превратить","Convert"],Rate:["Рейтинг","Rate"],Pos:["Место","Position"],Top:["Топ","Top"],Statistics_day:["Статистика за день","Statistics per day"],Statistics_week:["Статистика за неделю","Statistics per week"],Statistics_month:["Статистика за месяц","Statistics per month"],Statistics_neighbors:["Статистика соседи","Statistics neighbors"],Statistics:["Статистика","Statistics"],Day:["День","Day"],Week:["Неделя","Week"],Month:["Месяц","Month"],Neighbors:["Соседи по рейтингу","Neighbors"],logo:["В Шахматы 2.0","VChess 2.0"],logout:["выход","log out"],login_fb:["Войти через Facebook","login with Facebook "],login_vk:["Войти через ВКонтакте","login with VK"],Share:["Рассказать","Share"],Loading:["Загрузка данных...","Loading data..."],Attention:["Внимание","Attention"],RatePlace:["рейтинг, место","rate, place"],Games:["игры","games"],YouWin:["Вы победили!","You win!"],YouLost:["Вы проиграли...","You lost..."],PatResult:["Итог: ПАТ","Pat"],GameCanceled:["Игра не состоялась!","Game canceled"],Confirm:["Подтверждение","Confirm"],Cancel:["Отмена","Cancel"],Yes:["Да","Yes"],OfferPat:["Предложить сопернику ПАТ","Offer pat"],GiveUp:["Сдаться","Give up"],Welcome:["Добро пожаловать в ","Welcome"],NeedLogin:["Необходимо войти","Please login"],Watch:["Наблюдать","Watch"],Exit:["Выход","Exit"],call:["Вызов","Invite"],ClickToReport:["Нажмите если произошла ошибка","Click here to report a bug"],DescribeError:["Опишите ошибку","Describe a bug"],ReportError:["Сообщить об ошибке","Send report"],ExitGameText:["Если сделано 10 или менее ходов игра не состоится. Выйти?","If less than 10 steps done game can be canceled. Cancel game?"],SoundVolume:["Громкость звука","Sound volume"],Options:["Настройки","Setup"]};BufferLoader.prototype.loadBuffer=function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.responseType="arraybuffer";var d=this;c.onload=function(){d.context.decodeAudioData(c.response,function(c){return c?(d.bufferList[b]=c,void(++d.loadCount==d.urlList.length&&d.onload(d.bufferList))):void alert("error decoding file data: "+a)},function(a){console.error("decodeAudioData error",a)})},c.onerror=function(){alert("BufferLoader: XHR error")},c.send()},angular.module("siteApp").controller("MainCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("siteApp").controller("AboutCtrl",["ApiService","$scope","$sce",function(a,b,c){function d(a){var b=parseInt(a),c=b%1e3,d=b%6e4,e=(b-d)/6e4;return d=Math.floor(d/1e3),String(e+":"+d+"."+c)}function e(a){var b=a;switch(a){case 1:return"END_CANCEL_W";case 2:return"END_CANCEL_B";case 3:return"END_CANCEL_AND_FAIL_W";case 4:return"END_CANCEL_AND_FAIL_B";case 5:return"END_GONE_W";case 6:return"END_GONE_B";case 7:return"END_TIME_L_W";case 8:return"END_TIME_L_B";case 9:return"END_TIME_G_W";case 10:return"END_TIME_G_B";case 11:return"END_WIN_W";case 12:return"END_WIN_B";case 13:return"END_PAT_AGREED";case 14:return"END_PAT";case 15:return"END_TIME_G_CANCEL";case 16:return"END_TIME_L_CANCEL"}return b}function f(a){switch(a){case"M1":return"Черные выиграли";case"M2":return"Белые выиграли";case"PAT":return"ничья";case"CN":return"отмена"}}function g(){for(var a=[],c=0,d=0;8>d;d++){a[d]=[];for(var e=0;8>e;e++)a[d][e]={col:c%2==0?0:1},c++;c++}b.cells=a}function h(a){for(var d=0;d<a.length;d++)b.cells[a[d].x][a[d].y].fig=c.trustAsHtml(a[d].fig)}this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"];var i,j=[],k=new Date,l=new Date(k.getFullYear()-2,k.getMonth(),k.getDate()).valueOf(),m=[];a.getErrorReports().then(function(a){i=a.chess_error;for(var c=[],d=0;d<i.length;d++)if(!(1e3*i[d].battle_id<l))try{var e=JSON.parse(i[d].data);i[d].data=e;var f;e[0].uidw&&e[0].uidb&&(f=e[0].uidw+" "+e[0].uidb),e[1].uidw&&e[1].uidb&&(f=e[1].uidw+" "+e[1].uidb),m.push(i[d]);var g=(e.filter(function(a){return"object"!=typeof a}),new Date(1e3*i[d].battle_id)),h=g.getFullYear()+"-"+(g.getMonth()+1)+"-"+g.getDate(),k=new Date(h);i[d].date_str=h+" "+g.getHours()+":"+g.getMinutes()+" "+f,i[d].i=d;var n=c.map(function(a){return a[0]==h}),o=n.indexOf(!0);-1==o?c.push([h,k,0]):c[o][2]++}catch(p){console.log(i[d].data)}for(var d=0;d<c.length;d++)j.push([c[d][1],c[d][2]]);b.reports=m});var n=["&#9812;","&#9813;","&#9814;","&#9815;","&#9816;","&#9817;","&#9818;","&#9819;","&#9820;","&#9821;","&#9822;","&#9823;"],o=[{fig:"&#9823;",x:0,y:0,tn:0,t:0},{fig:"&#9820;",x:0,y:0,tn:0,t:0},{fig:"&#9822;",x:0,y:0,tn:0,t:0},{fig:"&#9821;",x:0,y:0,tn:0,t:0},{fig:"&#9819;",x:0,y:0,tn:0,t:0},{fig:"&#9818;",x:0,y:0,tn:0,t:0},{fig:"&#9817;",x:0,y:0,tn:0,t:0},{fig:"&#9814;",x:0,y:0,tn:0,t:0},{fig:"&#9816;",x:0,y:0,tn:0,t:0},{fig:"&#9815;",x:0,y:0,tn:0,t:0},{fig:"&#9813;",x:0,y:0,tn:0,t:0},{fig:"&#9812;",x:0,y:0,tn:0,t:0}];b.htmlfigs=[];for(var p=n.length-1;p>=0;p--)b.htmlfigs[p]=c.trustAsHtml(n[p]);b.curStep=-1,b.readReport=function(a){b.cur=a.i,b.steps=a.data,b.gameResult=e(a.res);for(var c=0;c<b.steps.length;c++)"object"==typeof b.steps[c]&&(b.steps[c].time_str=d(b.steps[c].time)),b.steps[c].ltime&&(b.steps[c].ltime_str=d(b.steps[c].ltime));"number"==typeof b.steps[b.steps.length-2]&&(b.gameResult=e(b.steps[b.steps.length-2])),"string"==typeof b.steps[b.steps.length-1]&&(b.comment=e(b.steps[b.steps.length-1])),b.curStep=-1,g()},g(),b.nextStep=function(){b.curStep=b.curStep+1,b.drawStep(b.curStep)},b.drawStep=function(a){b.curStep=a;var c=b.steps[a];if(console.log(c),c){var i=c.brd,j=[];if(!i)return;g(),b.trw=b.trb=b.res=b.resinfo=b.from="",c.trw&&(b.trw=d(c.trw)),c.trb&&(b.trb=d(c.trb)),c.res&&(b.res=f(c.res)),c.resinfo&&(b.resinfo=e(c.resinfo)),c.from&&(b.from=e(c.from));var k=JSON.stringify(c);for(b.info=k,b.step=c;-1!=i.indexOf("u00");){var a=i.indexOf("u00");if(-1!=a){var l=i.substr(0,a),m=i.substr(a+1,4),n=String.fromCharCode(parseInt(m,16)),p=i.substr(a+5);i=l+n+p}}for(var q,r,s,t,u,v,w=0;w<i.length;w++){var x=i.charCodeAt(w);if(q=x>>8&255,t=255&x,s=15&q,r=q>>4&15,u=t>>4&15,v=15&t,o[6*parseInt(w/16)+v]){var y={x:r,y:s,fig:o[6*parseInt(w/16)+v].fig};u||j.push(y)}else console.log("type not found",6*parseInt(w/16)+v)}h(j)}}}]),angular.module("siteApp").service("ApiService",["$http","$rootScope",function(a,b){function c(a){return a.data}function d(a){b.ShowAlert("Сервер не отвечает.")}return{getConfig:function(){return a.get("api/config.json").then(c)["catch"](d)},getErrorReports:function(){return console.log(server_config.host),a.post(server_config.host+"reports.php",{method:"get_reports"}).then(c)["catch"](d)},addReport:function(b,e,f){return a.post(server_config.nodeapi+"api/addreport",{battle_id:e,uid:b,data:f}).then(c)["catch"](d)},getTours:function(){return a.post(server_config.phpapi+"tournaments.php",{method:"get_tournaments"}).then(c)["catch"](d)},addTour:function(b,e,f,g){return a.post(server_config.phpapi+"tournaments.php",{method:"add_tournament",start:b,time:e,title:f,size:g}).then(c)["catch"](d)},deleteTour:function(b){return a.post(server_config.phpapi+"tournaments.php",{method:"del_tournament",id:b}).then(c)["catch"](d)},auth:function(b,e,f){return a.post(server_config.nodeapi+"api/auth",{uid:b,fname:e,lname:f}).then(c)["catch"](d)},getRates100:function(b){return a.post(server_config.nodeapi+"api/get_rates_100_2",{uid:b,time:0}).then(c)["catch"](d)},getRates:function(b,e){return a.post(server_config.nodeapi+"api/get_rates",{uid:b,time:e}).then(c)["catch"](d)},getRatesN:function(b,e){return a.post(server_config.nodeapi+"api/get_rates_n",{uid:b,time:e}).then(c)["catch"](d)},wallUpl:function(b){return a.post(server_config.nodeapi+"api/upl",{upload_url:b}).then(c)["catch"](d)}}}]),angular.module("siteApp").controller("ToursCtrl",["ApiService","$scope","$sce",function(a,b,c){function d(a){return b.dt.getFullYear()+"-"+("0"+(b.dt.getMonth()+1)).slice(-2)+"-"+("0"+b.dt.getDate()).slice(-2)}function e(a){for(var c=a.tournaments.length-1;c>=0;c--)a.tournaments[c].starttime=new Date(1e3*a.tournaments[c].starttime).toLocaleString();b.tours=a.tournaments}function f(a){var b=a.date,c=a.mode;return"day"===c&&(0===b.getDay()||6===b.getDay())}function g(a){var c=a.date,d=a.mode;if("day"===d)for(var e=new Date(c).setHours(0,0,0,0),f=0;f<b.events.length;f++){var g=new Date(b.events[f].date).setHours(0,0,0,0);if(e===g)return b.events[f].status}}this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.getTours().then(function(a){e(a)}),b.addTour=function(){var c=d(b.dt)+" "+b.startHour+":"+("0"+b.startMinutes).slice(-2),f=new Date(c).valueOf()/1e3;a.addTour(f,b.time.value,b.title,b.size).then(function(a){e(a)})},b.deleteTournament=function(b){a.deleteTour(b).then(function(a){e(a)})},b.today=function(){b.dt=new Date,b.dt2=new Date},b.today(),b.title="Турнир",b.clear=function(){b.dt=null},b.inlineOptions={customClass:g,minDate:new Date,showWeeks:!0},b.dateOptions={dateDisabled:f,formatYear:"yy",maxDate:new Date(2020,5,22),minDate:new Date,startingDay:1},b.toggleMin=function(){b.inlineOptions.minDate=b.inlineOptions.minDate?null:new Date,b.dateOptions.minDate=b.inlineOptions.minDate},b.toggleMin(),b.open1=function(){b.popup1.opened=!0},b.open2=function(){b.popup2.opened=!0},b.setDate=function(a,c,d){b.dt=new Date(a,c,d)},b.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],b.format=b.formats[1],b.altInputFormats=["M!/d!/yyyy"],b.popup1={opened:!1},b.popup2={opened:!1};var h=new Date;h.setDate(h.getDate()+1);var i=new Date;i.setDate(h.getDate()+1),b.events=[{date:h,status:"full"},{date:i,status:"partially"}],b.startHour="12",b.startMinutes="00",b.endHour="13",b.endMinutes="00";for(var j=[],k=0;24>k;k++)j.push(("0"+String(k)).slice(-2));b.hours=j;for(var l=[],k=0;60>k;k++)l.push(("0"+String(k)).slice(-2));b.minutes=l;for(var m=[],k=0;20>k;k++)m.push(k);b.sizes=m,b.size=10;var n=[{label:"15 мин, 3 мин на ход",value:"15:3"},{label:"5 мин, 1 мин на ход",value:"5:1"},{label:"20 мин, без лимита на ход",value:"20:0"}];b.timeControl=n,b.time=n[0]}]),angular.module("siteApp").controller("LobbyCtrl",["$scope","$rootScope","socket","ApiService","$uibModal","$log","messagesService","gameService","$location","AuthService",function(a,b,c,d,e,f,g,h,i,j){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"];h.setData({}),g.room=null;var k=["5","10","15","20","30","60"],l=["1","3","5","нет"],m=function(b,c){var d=a.playerslist.filter(function(a){return a[b]==c?a:void 0});return d&&1==d.length?d[0]:null};a.$on("socket:connect_error",function(a,c){console.log("connect_error",c),b.ShowAlert("Сервер недоступен, попробуйте зайти позже.")}),a.$on("socket:connect",function(a,b){}),a.$on("socket:message",function(a,b){g.recieve(b)}),b.mode="lobby",a.$on("socket:start",function(a,c){c.user1=b.myuser;b.myuser.uid==c.w&&(c.user2=m("uid",c.b)),b.myuser.uid==c.b&&(c.user2=m("uid",c.w)),c.user2&&(b.myuser.invuid=null,h.setData(c),i.path("playground"))}),a.$on("socket:alert",function(a,c){console.log("alert",c),b.ShowAlert(c)}),a.$on("socket:invuid",function(a,b){f.info("invite recieved",b);m("uid",b.from);playSound(SOUND_TAP)}),c.emit("userslist",{});var n=1,o=new chessBoardBase,p=o.initBoardCells();a.cells=o.initChessBoard(p,n);var q={myColor:FigureTypes.WHITE};o.initFigures(q,null),o.arrangeFigures("600,1600,2600,3600,4600,5600,6600,7600,701,1702,2703,3704,4705,5703,6702,7701,100,1100,2100,3100,4100,5100,6100,7100,1,1002,2003,3004,4005,5003,6002,7001"),a.view_letters=[],a.view_numbers=[],a.view_letters=o.letters,a.view_numbers=o.numbers.slice().reverse(),a.inviteOpen=function(a){var d=e.open({templateUrl:"modal/inviteModal.html",controller:"InviteModalCtrl as vm",animation:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:function(){return null==a.col&&(a.col=1),null==a.tmr&&(a.tmr=15),null==a.tc&&(a.tc=3),a.inv&&(a.inv=null),{player:a,title:"Пригласить",tcTotalItems:k,tcLocalItems:l}}}});d.result.then(function(d){var e={uid:[a.uid],tmr:d.tmr,tc:d.tc,col:d.col};if("single"==d.mode)e.uid=[a.uid],b.myuser.invuid=e.uid;else{var g=b.playerslist.filter(function(a){return 3===a.st});e.uid=g.map(function(a){return a.uid}),b.myuser.invuid=e.uid}f.info("invite send",e),c.emit("invuid",e)},function(a){console.log(a)})},a.inviteAgreeOpen=function(a){var d=e.open({templateUrl:"modal/inviteModal.html",controller:"InviteModalCtrl as vm",animation:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:function(){return{player:a,title:"Играем?",isAgreeMode:!0,tcTotalItems:k,tcLocalItems:l}}}});d.result.then(function(d){var e={uid:[a.uid],tc:d.tc,tmr:d.tmr,col:d.col};b.myuser.invuid=[a.uid],f.info("invite send",e),c.emit("invuid",e)},function(a){console.log(a)})},a.openRates100=function(){var a=e.open({templateUrl:"modal/popupRates100.html",controller:"PopupRates100Ctrl",animation:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:function(){return{uid:b.myuser.uid}}}});a.result.then(function(a){f.info("reates ok")},function(a){console.log(a)})},a.openRates=function(){var a=e.open({templateUrl:"modal/popupRates.html",controller:"PopupRatesCtrl",animation:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:function(){return{uid:b.myuser.uid}}}});a.result.then(function(a){f.info("reates ok")},function(a){console.log(a)})},a.openHelp=function(){var a=e.open({templateUrl:"modal/popupHelp.html",controller:"PopupHelpCtrl",animation:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:function(){return{uid:b.myuser.uid}}}});a.result.then(function(a){f.info("reates ok")},function(a){console.log(a)})},a.watchClick=function(c){for(var d in b.playersPlayinglist)b.playersPlayinglist[d].active=!1;c.active=!0,a.watching=c,b.currentWatch=c},a.$on("socket:watch",function(c,d){if(d&&b.currentWatch)if(d.b&&d.w&&(d.w==b.currentWatch.pair[0].uid?(b.currentWatch.pair[0].color=b.dict_words.White,b.currentWatch.pair[1].color=b.dict_words.Black):(b.currentWatch.pair[1].color=b.dict_words.White,b.currentWatch.pair[0].color=b.dict_words.Black)),d.brd&&o.arrangeFigures(d.brd),a.watching||(a.watching=b.currentWatch),d.res){var e=o.resinfo[d.resinfo][b.active_dict];switch(d.res){case"M1":a.watch_res=e;break;case"M2":a.watch_res=e;break;case"PAT":a.watch_res=e;break;case"CN":a.watch_res=e}}else a.watch_res=null}),a.onFriendCallClick=function(a){"vk"==server_config.platform&&(console.log(a),VK.callMethod("callUser",a.id,"call1234","Может партию в шахматы?")),"fb"==server_config.platform&&FB.ui({method:"apprequests",message:"Hey lets play chess?"},function(a){console.log(a)})},a.onFriendReqClick=function(a){"vk"==server_config.platform&&VK.callMethod("showRequestBox",a.id,"Может партию в шахматы?","myRequestKey")},a.testShare=function(){FB.ui({method:"share",href:"http://vchess.herokuapp.com/img/gif/logowide.png",quote:"just won and stepped 1st place!"},function(a){})},a.readAch=function(){FB.api("/me/achievements",function(a){a&&!a.error})},a.createAch=function(){FB.api("/me/objects/game.achievement","POST",{object:'{"fb:app_id":"1439706896109510","og:type":"game.achievement","og:url":"https:\\/\\/apps.facebook.com\\/v_chess\\/","og:title":"Sample Game Achievement","og:image":"https:\\/\\/vchess.herokuapp.com\\/images\\/logo200.png","game:points":"1"}'},function(a){a&&!a.error&&console.log(a)})},a.updateAch=function(){FB.api("/id_from_create_call","POST",{object:'{"fb:app_id":"1439706896109510","og:type":"game.achievement","og:url":"Put your own URL to the object here","og:title":"Sample Game Achievement","og:image":"https:\\/\\/s-static.ak.fbcdn.net\\/images\\/devsite\\/attachment_blank.png","game:points":"Sample Points"}'},function(a){a&&!a.error})},a.deleteAch=function(){FB.api("/id_from_create_call","DELETE",function(a){a&&!a.error})},a.postAch=function(){FB.api("/me/achievements","POST",{achievement:"116712102371226"},function(a){a&&!a.error&&console.log(a)})}}]),angular.module("siteApp").controller("PopupRates100Ctrl",["$uibModalInstance","$scope","$log","items","ApiService",function(a,b,c,d,e){e.getRates100(d.uid,0).then(function(a){console.log("resp",a.response.data),b.list=a.response.data},function(a){console.log("error",a)}),b.onOk=function(){a.dismiss("cancel")},b.onPublish=function(){a.dismiss("cancel")}}]),angular.module("siteApp").controller("PopupRatesCtrl",["$uibModalInstance","$scope","$log","items","ApiService",function(a,b,c,d,e){var f,g,h=[],i={},j=function(a){i={};for(var c=0;c<a.names.length;c++)i[a.names[c].uid]=a.names[c].fname+" "+a.names[c].lname;for(var d={},c=0;c<a.data.length;c++)d[a.data[c].uid]||(d[a.data[c].uid]=[]),d[a.data[c].uid].push(a.data[c]);f=[];for(var e in d)f.push(e);for(var g={},c=0;c<a.data.length;c++)a.data[c].battle_id>2e9||(g[a.data[c].battle_id]||(g[a.data[c].battle_id]=[]),g[a.data[c].battle_id].push(a.data[c]));var j=[];for(var k in g)j.push(parseInt(k));j=j.sort(),h=[];for(var l=0;l<j.length;l++){for(var m=[new Date(1e3*j[l])],c=0;c<f.length;c++){for(var n=d[f[c]],o=null,p=0;p<n.length;p++)n[p].battle_id==j[l]&&(o=n[p].rate);0==l&&(o=n[0].rate),l==j.length-1&&(o=n[n.length-1].rate),m.push(o)}h.push(m)}a.list=null,g=null,d=null,b.uids_list=f},k=function(){g&&g.clearChart();var a=new google.visualization.DataTable;a.addColumn("datetime","time");for(var b=0;b<f.length;b++)a.addColumn("number",i[f[b]]);a.addRows(h);var c={title:"Company Performance",interpolateNulls:!0,legend:{position:"top",maxLines:4},title:"Статистика за день",height:600,chartArea:{height:400,top:120,left:50,right:50}};g=new google.visualization.LineChart(document.getElementById("chart")),g.draw(a,c)};e.getRates(d.uid,0).then(function(a){b.list=a.response.data,j(a.response),google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(k)},function(a){console.log("error",a)}),b.onRates=function(a){e.getRates(d.uid,a).then(function(a){b.list=a.response.data,j(a.response),k()},function(a){console.log("error",a)})},b.onRatesN=function(a){e.getRatesN(d.uid,a).then(function(a){b.list=a.response.data,j(a.response),k()},function(a){console.log("error",a)})},b.onOk=function(){a.dismiss("cancel")},b.onPublish=function(){a.dismiss("cancel")}}]),angular.module("siteApp").controller("SocketCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("siteApp").factory("socket",["socketFactory",function(a){var b;b=server_config.local?io.connect(server_config.socket_host):io.connect(server_config.socket_host,{secure:!0});var c=a({ioSocket:b});return c.forward("auth"),c.forward("userslist"),c.forward("message"),c.forward("start"),c.forward("statusupd"),c.forward("watch"),c.forward("alert"),c.forward("invuid"),c.forward("game"),c.forward("connect_error"),c.forward("connect"),c}]),angular.module("siteApp").controller("AppControllerCtrl",["$rootScope","$scope","$uibModal","$log","$location","gameService","ApiService","AuthService","socket","$timeout","Options","SoundManager",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){VK.Auth.logout(function(a){d.info("logout",a),b.vkLoginVisible=!0,b.$$phase||b.$apply()})}function n(){return window.VK?void VK.init(function(){VK.api("friends.get",{fields:"photo_50"},function(c){var d=c.response.items;console.log(c),VK.api("friends.getAvailableForCall",{fields:"photo_50"},function(c){var e=c.response.items,f=e.map(function(a){return a.id});d.filter(function(a){a.callable=-1!=f.indexOf(a.id)}),a.friendsList=d,b.$$phase||b.$apply(),console.log(c)})}),VK.api("users.get",{fields:"city,photo"},function(a){if(a.response){console.log("users.get",a.response);var c=a.response[0];console.log("saveAuthInfo",c),c&&(h.saveAuthInfo(c),b.auth(c))}})},function(a){console.log(" API initialization failed ")},"5.60"):void j(n,500)}function o(c){VK.Api.call("users.get",{user_ids:c.mid,fields:"city,photo"},function(a){if(a.response){var c=a.response[0];h.saveAuthInfo(c),b.auth(c)}}),VK.Api.call("friends.get",{fields:"photo_50"},function(b){a.friendsList=b.response})}this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.loginVisible=!1,"local"==server_config.platform&&(b.fbLoginVisible=!0,b.vkLoginVisible=!0);var p=k.getOptions();l.setVolume(p.volume),a.sound_toggle=p.sound?"images/sndon_btn.png?t=1":"images/sndoff_btn.png?t=1",a.openSoundToggle=function(){var b=k.getOptions();b.sound=!b.sound,a.sound_toggle=b.sound?"images/sndon_btn.png?t=1":"images/sndoff_btn.png?t=1",k.setSound(b.sound)},a.openOptions=function(){a.OptionsModal()},b.modalPopup=function(a){var d=c.open({templateUrl:"modal/alertModal.html",controller:"AlertModalCtrl",controllerAs:"$ctrl",animation:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",backdrop:"static",resolve:{items:function(){return{body:a}}}});return b.modalInstance=d,d.result},a.OptionsModal=function(){var a=c.open({templateUrl:"modal/OptionsModal.html",controller:"OptionsCtrl",backdrop:"static",animation:!1,keyboard:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",controllerAs:"$ctrl",resolve:{items:{vkLoginVisible:b.vkLoginVisible,fbLoginVisible:b.fbLoginVisible}}});a.result.then(function(a){console.log("1",a),"vk"===a&&(b.vkauth(),e.path("lobby")),"fb"===a&&(b.fblogin(),e.path("lobby"))},function(a){console.log("2",a)})},a.WelcomeModal=function(){var a=c.open({templateUrl:"modal/WelcomeModal.html",controller:"WelcomeLoginCtrl",backdrop:"static",animation:!1,keyboard:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",controllerAs:"$ctrl",resolve:{items:{vkLoginVisible:b.vkLoginVisible,fbLoginVisible:b.fbLoginVisible}}});a.result.then(function(a){console.log("1",a),"vk"===a&&(b.vkauth(),e.path("lobby")),"fb"===a&&(b.fblogin(),e.path("lobby"))},function(a){console.log("2",a)})},a.DrawBoardModal=function(a,b){var d=c.open({templateUrl:"modal/BoardDrawModal.html",controller:"BoardDrawController",backdrop:"static",animation:!1,keyboard:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",controllerAs:"$ctrl",resolve:{items:{stepsList:a,resInfo:b}}});d.result.then(function(a){},function(a){console.log("2",a)})},("vk-mobile"==server_config.platform||"local"==server_config.platform)&&(loadVKMobile(document,"script","vk-open-sdk"),setTimeout(function(){n()},2e3)),("vk-open"==server_config.platform||"local"==server_config.platform)&&(loadVKOpenApi(document,"script","vk-open-sdk"),window.vkAsyncInit=function(){VK.init({apiId:6163095}),"vk-open"==server_config.platform&&VK.Auth.getLoginStatus(function(c){d.info(c),null==c.session?(b.vkLoginVisible=!0,b.$$phase||b.$apply(),a.WelcomeModal()):o(c.session)})}),b.checkLoginState=function(){FB.getLoginStatus(function(c){if("connected"===c.status){c.authResponse.userID,c.authResponse.accessToken;console.log(c),FB.api("/me",{fields:"first_name,last_name,picture"},function(c){if(console.log("Good to see you, ",c),c.first_name&&c.last_name&&c.id){var d={first_name:c.first_name,last_name:c.last_name,fbid:c.id,photo:c.picture.data.url};b.auth_fb(d)}FB.api("/"+c.id+"/taggable_friends",function(c){if(c&&!c.error){console.log(c);var d=c.data;d.filter(function(a){a.photo_50=a.picture.data.url,a.callable=!0}),a.friendsList=d,b.$$phase||b.$apply()}})})}else"not_authorized"===c.status?(console.log(c),b.fbLoginVisible=!0,b.$$phase||b.$apply(),a.WelcomeModal()):(console.log(c),b.fbLoginVisible=!0,b.$$phase||b.$apply(),a.WelcomeModal())})},("fb"==server_config.platform||"local"==server_config.platform)&&(loadFBApi(document,"script","facebook-jssdk"),window.fbAsyncInit=function(){j(function(){FB.init({appId:fbAppId,autoLogAppEvents:!0,xfbml:!0,version:"v2.10"}),FB.AppEvents.logPageView(),"fb"==server_config.platform&&b.checkLoginState()})}),"vk"==server_config.platform&&(loadVKIframe(document,"script","vk-iframe-sdk"),n());var q=!1;a.ShowAlert=function(a){q||(q=!0,b.modalPopup(a).then(function(a){q=!1,b.handleSuccess(a)}).then(null,function(a){q=!1,b.handleDismiss(a)}))},b.handleSuccess=function(a){d.info("Modal closed: "+a)},b.handleDismiss=function(a){d.info("Modal dismissed: "+a)},b.logout=function(){"vk-open"==server_config.platform&&(a.myuser=null,m()),"fb"==server_config.platform&&FB.logout(function(a){d.info("logout",a),b.fbLoginVisible=!0,deleteCookie("fblo_"+fbAppId),b.$$phase||b.$apply()})},a.ShowLogin=function(a){q||(q=!0,b.modalPopup(a).then(function(a){q=!1,b.handleSuccess(a)}).then(null,function(a){q=!1,b.handleDismiss(a)}))};var r=function(a){var b="https://vk.com/images/camera_50.png";return{uid:a,first_name:"Андрей "+a,last_name:"aaa",photo:b}};b.login=function(){s=r(b.username),i.socket.connected,b.auth(s)},b.vkauth=function(){VK.Auth.login(function(b){a.myuser=b.user,b.session&&o(b.session)},4)},b.auth=function(c){h.saveAuthInfo(c),c&&c.uid?(i.emit("auth",c),a.loginVisible=!1,b.$$phase||b.$apply()):a.myuser=null,c&&c.id?(c.uid=c.id,console.log("emit auth"),i.emit("auth",c),a.loginVisible=!1,b.$$phase||b.$apply()):a.myuser=null},b.nickLogin=function(){a.loginVisible=!0},b.fblogin=function(){FB.login(function(a){a.authResponse?(console.log("Welcome!  Fetching your information.... ",a),b.checkLoginState()):console.log("User cancelled login or did not fully authorize.")},{scope:"user_friends, publish_actions"})},b.auth_fb=function(c){h.saveAuthInfo(c),c&&c.fbid?(console.log("emit auth"),i.emit("auth",c),a.loginVisible=!1,b.$$phase||b.$apply()):a.myuser=null};var s;"en"==server_config.lang?a.active_dict=1:a.active_dict=0;var t=Object.keys(dict_words);a.dict_words={};for(var u in t)a.dict_words[t[u]]=dict_words[t[u]][a.active_dict];a.platform=server_config.platform,a.hidePreloader=!0,a.ConfirmGameExit=function(){var a=c.open({templateUrl:"modal/confirmExitGameModal.html",controller:"ConfirmgameexitCtrl",backdrop:"static",animation:!1,keyboard:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:{}}});a.result.then(function(a){console.log("1",a),a===!0&&(f.exitGame(),e.path("lobby"))},function(a){console.log("2",a)})},b.updateList=function(b){for(var c=b.filter(function(b){return b.uid!=a.myuser.uid&&4==b.st?b:void 0}),d={},e=0;e<b.length;e++)d[b[e].uid]=b[e];a.playersInviting=b.filter(function(b){return b.inv&&-1!=b.inv.to.indexOf(a.myuser.uid)}),a.playersInviting.length>0&&l.PlayTap();for(var f={},e=0;e<c.length;e++)f[c[e].sss]||(f[c[e].sss]={pair:[null,null]}),0==c[e].col&&(f[c[e].sss].pair[0]=c[e]),1==c[e].col&&(f[c[e].sss].pair[1]=c[e]);if(a.playersPlayinglist=f,a.playersPlayinglist_length=c.length,null==a.currentWatch){var g=a.playersPlayinglist[Object.keys(a.playersPlayinglist)[0]];g&&(a.currentWatch=g,i.emit("gamewatch",{sss:g.pair[0].sss}))}},b.$on("socket:auth",function(b,c){console.log("auth",c),c.me&&c.list&&(a.myuser=c.me,v(c.list))}),b.$on("socket:userslist",function(b,c){a.myuser&&v(c)});var v=function(c){a.playerslist=c.filter(function(b){return b.uid!=a.myuser.uid?b:void 0});var d=f.getData();if(d&&d.w&&d.b){var e=d.w==a.myuser.uid?d.b:d.w,g=c.filter(function(a){return a.uid==e?a:void 0});0==g.length&&(console.log("player gone!"),b.$broadcast("endgame","gone"))}b.updateList(a.playerslist)};b.$on("socket:statusupd",function(c,d){a.playerslist.forEach(function(a,b,c){d[c[b].uid]&&(null!=d[c[b].uid].st&&(c[b].st=d[c[b].uid].st),null!=d[c[b].uid].sss&&(c[b].sss=d[c[b].uid].sss),null!=d[c[b].uid].col&&(c[b].col=d[c[b].uid].col),c[b].inv=d[c[b].uid].inv)}),b.updateList(a.playerslist)})}]),angular.module("siteApp").controller("AlertModalCtrl",["$uibModalInstance","$log","items",function(a,b,c){var d=this;d.items=c,d.name="alert",d.title="Внимание",d.body=c.body,d.ok=function(){b.info("Modal ok"),a.dismiss("cancel")},d.cancel=function(){b.info("Modal cancel"),a.dismiss("cancel")}}]),angular.module("siteApp").controller("WelcomeLoginCtrl",["$uibModalInstance","$log","items",function(a,b,c){window.fbAsyncInit=function(){FB.init({appId:fbAppId,autoLogAppEvents:!0,xfbml:!0,version:"v2.10"}),FB.AppEvents.logPageView()};var d=this;d.items=c,d.vkLoginVisible=c.vkLoginVisible,d.fbLoginVisible=c.fbLoginVisible,d.name="login",d.title="Добро пожаловать в ",d.body=c.body,d.ok=function(c){b.info("Modal ok"),a.close(c)},d.cancel=function(){b.info("Modal cancel"),a.dismiss("cancel")}}]),angular.module("siteApp").controller("OptionsCtrl",["$uibModalInstance","$log","items","Options","SoundManager",function(a,b,c,d,e){var f=this;f.items=c;var g=d.getOptions();f.volume={range:{min:0,max:100},min:0,max:g.volume},a.rendered.then(function(){console.log("rendered")}),f.ok=function(){b.info("Modal ok"),a.close()},f.cancel=function(){b.info("Modal cancel"),g.volume=f.volume.max,e.setVolume(g.volume),d.setOptions(g),a.dismiss("cancel")}}]),angular.module("siteApp").controller("PopupHelpCtrl",["$uibModalInstance","$log","items","$scope",function(a,b,c,d){d.onOk=function(){b.info("Modal ok"),a.dismiss("cancel")},d.onCancel=function(){b.info("Modal cancel"),a.dismiss("cancel")}}]),angular.module("siteApp").controller("BoardDrawController",["$uibModalInstance","$log","items","$rootScope","ApiService",function(a,b,c,d,e){function f(a){for(var b=atob(a.split(",")[1]),c=new ArrayBuffer(b.length),d=new Uint8Array(c),e=0;e<b.length;e++)d[e]=b.charCodeAt(e);return new Blob([c],{type:"image/jpeg"})}var g=this;g.items=c,g.brd=c.board;var h,i,j=c.stepsList,k="#eeceb4",l="#c59d79";a.rendered.then(function(){function a(a,b,c){e.arrangeFigures(c);var d=0,f=0,i=0;for(var j in n)for(var m in n[j])d=i%8,f=Math.floor(i/8),i%2==0?f%2==0?h.fillStyle=l:h.fillStyle=k:f%2==0?h.fillStyle=k:h.fillStyle=l,h.fillRect(a+d*g,b+f*g,g,g),i++;i=0,h.fillStyle="rgb(0, 0, 0)";for(var j in n)for(var m in n[j])d=i%8,f=Math.floor(i/8),h.font=g-3+"px serif",n[j][m].fig&&h.fillText(String.fromCharCode(q[n[j][m].fig.figType+n[j][m].fig.figColor]),a+d*g,b+(g-5)+f*g),i++}i=document.getElementById("canvas"),h=i.getContext("2d");var e=new chessBoardBase,f=1,g=30,m=e.initBoardCells(),n=e.initChessBoard(m,f),o={myColor:FigureTypes.WHITE};e.initFigures(o,null);var p=j.length-1,q={kingwhite:"9812",queenwhite:"9813",ladiawhite:"9814",slonwhite:"9815",konwhite:"9816",peshkawhite:"9817",kingblack:"9818",queenblack:"9819",ladiablack:"9820",slonblack:"9821",konblack:"9822",peshkablack:"9823"},r=5,s=j[p];b.info(j[p]),h.fillStyle="#fefefe",h.fillRect(0,0,500,600),a(r+0,0,j[p-4].brd),a(r+250,0,j[p-3].brd),a(r+0,250,j[p-2].brd),a(r+250,250,j[p-1].brd);var t,u,v;"M1"==s.res&&(d.myuser.uid==s.w?(t=d.myuser.first_name+" проиграл в шахматы",u="Новый рейтинг: "+s.rw,v="Занимает "+ +s.posw+" место "):(t=d.myuser.first_name+" победил в шахматы",u="Новый рейтинг: "+s.rb,v="Занимает "+ +s.posb+" место ")),"M2"==s.res&&(d.myuser.uid==s.w?(t=d.myuser.first_name+" победил в шахматы",u="Новый рейтинг: "+s.rw,v="Занимает "+ +s.posw+" место "):(t=d.myuser.first_name+" проиграл в шахматы",u="Новый рейтинг: "+s.rb,v="Занимает "+ +s.posb+" место ")),("M1"==s.res||"M2"==s.res)&&(h.font="20px serif",h.fillText(c.resInfo,10,255+8*g+20),h.fillText(t,10,255+8*g+45),h.fillText(u,10,255+8*g+70),h.fillText(v,10,255+8*g+95))}),g.share=function(){function b(a){VK.api("photos.getWallUploadServer",{},function(b){var c=b.response.user_id,d=new FormData;d.append("photo",a),d.append("upload_url",b.response.upload_url),d.append("uid",c);var e=new XMLHttpRequest;e.open("POST",server_config.nodeapi+"api/upl",!0),e.onload=e.onerror=function(){console.log(e.responseText);var a=JSON.parse(e.responseText);console.log("ok",a),VK.api("photos.saveWallPhoto",{user_id:c,server:a.server,photo:a.photo,
hash:a.hash},function(a){console.log(a.response),VK.api("wall.post",{attachments:"photo"+a.response[0].owner_id+"_"+a.response[0].id},function(a){console.log(a)})})},e.send(d)})}var c=i.toDataURL("image/jpeg",1),d=f(c);"vk"==server_config.platform&&b(d),"fb"==server_config.platform,a.dismiss("cancel")},g.ok=function(c){b.info("Modal ok"),a.close(c)},g.cancel=function(){b.info("Modal cancel"),a.dismiss("cancel")}}]),angular.module("siteApp").controller("InviteModalCtrl",["$scope","items","$log","$uibModalInstance","$rootScope",function(a,b,c,d,e){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"];var f=this;f.inviteMode=null,f.player=b.player,f.tcTotalItems=b.tcTotalItems,f.tcLocalItems=b.tcLocalItems,f.colorItems=[e.dict_words.Black,e.dict_words.White],1==b.isAgreeMode?(f.tmr=b.player.inv.tmr,f.tc=b.player.inv.tc,f.col=b.player.inv.col,f.title=e.dict_words.invited,f.agree=!0):(f.tmr=b.player.tmr,f.col=b.player.col,f.tc=b.player.tc,f.title=e.dict_words.Invite),f.color=0==f.col?e.dict_words.Black:e.dict_words.White,f.playerName=b.player.first_name+" "+b.player.last_name,f.activateTmr=function(a){f.tmr=a},f.activateTc=function(a){f.tc=a},f.activateColor=function(a){f.color=a,f.col=f.colorItems.indexOf(a)},f.onOk=function(){c.info("Modal ok"),d.close({tmr:f.tmr,tc:f.tc,col:f.col,mode:f.inviteMode})},f.onAgree=function(){c.info("Modal ok"),d.close({tmr:f.tmr,tc:f.tc,col:f.col})},f.onCancel=function(){c.info("Modal cancel"),d.dismiss("cancel")},f.onClose=function(){c.info("Modal cancel"),d.dismiss("close")}}]),angular.module("siteApp").service("messagesService",["$rootScope","socket",function(a,b){var c=null,d={name:"user"},e=function(a){console.log("send message",a),a.user&&b.emit("message",a)},f=function(a){c=a},g=function(a){a.user&&c(a)};return{addRecieveListener:f,recieve:g,send:e,user:d}}]),angular.module("siteApp").controller("ChatgCtrl",["messagesService","$scope","$timeout","$rootScope","socket",function(a,b,c,d,e){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],b.messages=[],a.addRecieveListener(function(a){b.messages.push(a),c(function(){var a=document.getElementById("autoscroll");a.scrollTop=a.scrollHeight},0,!1)}),b.send=function(){if(b.textbox&&b.textbox.length>0){var c={msg:b.textbox,user:d.myuser};null!=a.room?(c.sss=a.room,e.emit("game",c),a.recieve(c)):a.send(c),b.textbox=""}}}]),angular.module("siteApp").service("gameService",["socket",function(a){var b=this;this.data={},this.isFinished=!0,this.setData=function(a){b.data=a,this.isFinished=!1},this.getData=function(){return b.data},this.endGame=function(){this.isFinished=!0},this.exitGame=function(){console.log("exitgame"),this.isFinished=!0,this.setData({}),a.emit("exitgame",!0)}}]),angular.module("siteApp").controller("PlaygroundCtrl",["gameService","$scope","$uibModal","socket","$location","$timeout","$rootScope","messagesService","ApiService","SoundManager",function(a,b,c,d,e,f,g,h,i,j){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"];var k=this;k.isExitAvailable=!0;var l=function(a,b,c){function d(){if(g>=e)c(e,g);else if(!i){b(e,g),g++;var a=(new Date).getTime()-h-g*f;window.setTimeout(d,f-a)}}var e=a,f=1e3,g=0,h=(new Date).getTime(),i=!0;this.pause=function(){i=!0},this.resume=function(a){i=!1,g=0,h=(new Date).getTime(),window.setTimeout(d,f),console.log("resume count",g)},window.setTimeout(d,f)};b.historyList=[],b.stepsList=[],b.taken=[];var m,n,o,p,q,r,s,t,u,v=0,w=!1,x=0,y=10,z=new chessBoardBase,A=z.initBoardCells(),B="z_0:z_0",C=new chessHistory,D={},E=0,F=a.getData();h.room=F.sss,F&&F.user1&&F.user2?(b.user1=F.user1,b.user2=F.user2,s=60*F.trw,t=60*F.trw,u=E=0==F.tc||"нет"==F.tc?s:60*F.tc,b.tmrUser1=msToTime(s),b.tmrUser2=msToTime(t),p=new l(s,function(a){s--,0>s&&b.onGameOverByTime(),b.tmrUser1=msToTime(s),b.$$phase||b.$apply()},function(){b.tmrUser1=msToTime(0),b.onGameOverByTime()}),q=new l(t,function(a){t--,b.tmrUser2=msToTime(t),b.$$phase||b.$apply()},function(){b.tmrUser2=msToTime(0)}),r=new l(u,function(a){u--,0>u&&b.onGameOverByTime(),$(".time-line").css("width",u/E*100+"%"),b.tmrLocal=msToTime(u),b.$$phase||b.$apply()},function(){b.tmrLocal=msToTime(0),b.onGameOverByTime()})):b.showEmpty=!0,b.onGameOverByTime=function(){v>y?(0>=u&&(o.myColorConst==FigureTypes.BLACK?b.WhiteWinEnd(!0,FigureTypes.END_TIME_L_B):b.BlackWinEnd(!0,FigureTypes.END_TIME_L_W)),0>=s&&(o.myColorConst==FigureTypes.BLACK?b.WhiteWinEnd(!0,FigureTypes.END_TIME_G_B):b.BlackWinEnd(!0,FigureTypes.END_TIME_G_W))):(0>=u&&b.CancelEnd(FigureTypes.END_TIME_L_CANCEL),0>=s&&b.CancelEnd(FigureTypes.END_TIME_G_CANCEL)),j.PlayFail()},b.pause=function(){p.pause(),q.pause()},b.historyAppend=function(a){var c=C.append(a.type,a.color,a.step);o.lastStep=a.step,console.log(c),b.historyList.push(c)},b.boardCallback=function(a,d){switch(a){case"convert":break;case"history":var e=d.step.split(":"),f=e[1].split("_");if(o.myColorConst==FigureTypes.WHITE&&d.type==FigureTypes.PESHKA&&"8"==f[1]||o.myColorConst==FigureTypes.BLACK&&d.type==FigureTypes.PESHKA&&"1"==f[1]){var g=c.open({templateUrl:"modal/convertModal.html",controller:"ConvertModalCtrl",backdrop:"static",animation:!1,keyboard:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:{data:d,title:"Превратить пешку в:"}}});g.result.then(function(a){console.log(a),a.data.fig.convert(a.selected),b.NextTurn(a.data)},function(a){console.log(a)})}else b.NextTurn(d);break;case"check":b.isCheck=!0;break;case"taken":var h=new BaseFigure;h.init(d.figColor,d.figType),b.taken.push(h)}},b.NextTurn=function(a){b.historyAppend(a),b.isCheck=!1;var c=(z.boardToString(),z.gameCondition());switch(o.isMyTurn&&b.isCheck&&(b.isCheck=!1),v++,c){case 1:o.myColorConst==FigureTypes.WHITE?(b.WhiteWinEnd(!0,FigureTypes.END_WIN_W),console.log("WhiteWinEnd(true,true,END_WIN_W)")):(b.BlackWinEnd(!0,FigureTypes.END_WIN_B),console.log("BlackWinEnd(true,true, END_WIN_B)"));break;case 2:b.PatEnd(FigureTypes.END_PAT),console.log("PatEnd(true,END_PAT)");break;case-1:b.sendStep()}b.setMyTurn(!1),j.PlayStep2(),p&&p.pause(),r&&r.pause(),q&&q.resume()},b.$on("socket:game",function(a,c){return 1==c.offerpat?void b.onRecievePat():(c.msg&&h.recieve(c),1==c.saved&&(o.saved=!0),void(1==c.quit?o.myColorConst==FigureTypes.WHITE?b.WhiteWinEnd(!0,FigureTypes.END_CANCEL_AND_FAIL_W):b.BlackWinEnd(!0,FigureTypes.END_CANCEL_AND_FAIL_B):b.onGameStep(c)))}),b.onGameStep=function(a){b.stepsList.push(a),b.getBattleSocket(a)},b.getBattleSocket=function(a){if(null!=a.ww&&null!=a.pw&&null!=a.fw&&null!=a.rw&&null!=a.wb&&null!=a.pb&&null!=a.fb&&null!=a.rb&&D.results&&D.results(a),!w){var c=!1;if(c=o.myColorConst==FigureTypes.WHITE?a.num%2==0:a.num%2==1,x=parseInt(o.myColorConst==FigureTypes.WHITE?a.trb:a.trw),null!=a.res){"M1"==a.res&&b.BlackWinEnd(!1,a.resinfo),"M2"==a.res&&b.WhiteWinEnd(!1,a.resinfo),"PAT"==a.res&&b.PatEnd(a.resinfo),"CN"==a.res&&b.CancelEnd(a.resinfo);var d=!1;try{d=b.stepDone(a.brd)}catch(e){}return void(d||console.log("STEP NOT RECOGNIZED!!!"))}if(c&&a.num>=v){v=a.num,v>y&&(k.isExitAvailable=!1,b.btnEndVisible=!0),j.PlayStep1();var d=!1;try{d=b.stepDone(a.brd),p.resume();var f=0;o.myColorConst==FigureTypes.WHITE?(f=a.trb-t,t=a.trb):(f=a.trw-t,t=a.trw),console.log("dif",f),console.log("correct from ",b.tmrUser2,"to",msToTime(t)),q.pause()}catch(e){}d?(u=E>s?s:E,r.resume(!0)):console.log("STEP NOT RECOGNIZED!!!")}}},b.stepDone=function(a){for(var c,d,e,f,g,h,i=[],j=a.split(","),k=0;k<z.arrFigures.length;k++){var l=parseInt(j[k],16);if(g=l>>8&255,h=255&l,d=15&g,c=g>>4&15,f=h>>4&15,e=15&h,z.arrFigures[k].figType!=z.typesMap[e]&&z.arrFigures[k].convert(z.typesMap[e]),z.arrFigures[k].oldPlace!=z.XYToName(c,d)){var m={fig:z.arrFigures[k],oldp:z.arrFigures[k].oldPlace,newp:z.XYToName(c,d)};i.push(m)}}if(i.length>2)console.log("more than 2 figs moved");else{if(0!=i.length){if(b.AnimSteps(i,a),i.length>1){var n=0;("e_1"==i[0].oldp||"e_8"==i[0].oldp)&&(n=0),("e_1"==i[1].oldp||"e_8"==i[1].oldp)&&(n=1),b.historyAppend({time:x,step:i[n].oldp+":"+i[n].newp,color:i[n].fig.figColor,type:i[n].fig.figType})}else b.historyAppend({time:x,step:i[0].oldp+":"+i[0].newp,color:i[0].fig.figColor,type:i[0].fig.figType});return!0}console.log("no figs moved")}return!1},b.AnimSteps=function(a,c){z.arrangeFigures(c),z.cellOldMarker(a[0].oldp),z.cellOldMarker(a[0].newp),b.StartTurn()},b.StartTurn=function(){b.setMyTurn(!0),z.swapMy(),z.gameCondition(),z.swapMy()},b.$on("endgame",function(a,c){switch(console.log("endgame",c),c){case"gone":v>y?o.myColorConst==FigureTypes.BLACK?b.BlackWinEnd(!1,FigureTypes.END_GONE_W):b.WhiteWinEnd(!1,FigureTypes.END_GONE_B):o.myColorConst==FigureTypes.BLACK?b.CancelEnd(FigureTypes.END_CANCEL_B):b.CancelEnd(FigureTypes.END_CANCEL_W)}}),b.onToFail=function(){v>y?o.myColorConst==FigureTypes.BLACK?b.WhiteWinEnd(!1,FigureTypes.END_CANCEL_AND_FAIL_B):b.BlackWinEnd(!1,FigureTypes.END_CANCEL_AND_FAIL_W):o.myColorConst==FigureTypes.BLACK?b.CancelEnd(FigureTypes.END_CANCEL_B):b.CancelEnd(FigureTypes.END_CANCEL_W)},b.onToAgreePat=function(){b.PatEnd(FigureTypes.END_PAT_AGREED)},b.onSendPat=function(){d.emit("game",{offerpat:1,sss:F.sss})},b.btnEndVisible=!1,b.onRecievePat=function(){b.btnEndVisible=!1,b.btnEndAgreeVisible=!0},b.sendStep=function(a,c){var e;o.myColorConst==FigureTypes.WHITE?(e={from:F.user1.uid,brd:z.boardToString(),num:v,trw:s,res:a,w:F.w,b:F.b,bid:F.bid,resinfo:c,sss:F.sss},d.emit("game",e)):(e={from:F.user1.uid,brd:z.boardToString(),num:v,trb:s,w:F.w,b:F.b,bid:F.bid,res:a,resinfo:c,sss:F.sss},d.emit("game",e)),b.stepsList.push(e)},b.StartBlack=function(){b.setMyTurn(!1)},b.StartWhite=function(){b.setMyTurn(!0)},b.clickCell=function(a){z.cellClick(a)},b.setMyTurn=function(a){o.isMyTurn=a,b.isMyTurn=a},b.endGame=function(d,f){w=!0,a.endGame(),p.pause(),q.pause(),r.pause(),p=null,q=null,r=null,b.saveResult(d,f);var h="",i=0;switch(d){case"M1":h=o.myColorConst==FigureTypes.WHITE?g.dict_words.YouLost:g.dict_words.YouWin,i=o.myColorConst==FigureTypes.WHITE?0:1;break;case"M2":h=o.myColorConst==FigureTypes.WHITE?g.dict_words.YouWin:g.dict_words.YouLost,i=o.myColorConst==FigureTypes.WHITE?1:0;break;case"PAT":h=g.dict_words.PatResult,i=3;break;case"CNL":h=g.dict_words.GameCanceled,i=4}var j=z.resinfo[f][g.active_dict],k=c.open({templateUrl:"modal/endModal.html",controller:"EndModalCtrl",backdrop:"static",animation:!1,keyboard:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:{result:h,resultInfo:j,user1:b.user1,user2:b.user2,callback:D,res_code:i}}});k.result.then(function(a){var c=[FigureTypes.END_TIME_G_CANCEL,FigureTypes.END_TIME_L_CANCEL,FigureTypes.END_CANCEL_W,FigureTypes.END_CANCEL_B];-1==c.indexOf(f)&&g.DrawBoardModal(b.stepsList,j),e.path("lobby")},function(a){})},b.onOfferPat=function(){var a=c.open({size:"md",templateUrl:"modal/confirmPatGameModal.html",controller:"ConfirmgameexitCtrl",backdrop:"static",animation:!1,keyboard:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:{}}});a.result.then(function(a){console.log(a),b.onSendPat()},function(a){})},b.onExitGame=function(){var a=c.open({size:"sm",templateUrl:"modal/confirmEndGameModal.html",controller:"ConfirmgameexitCtrl",backdrop:"static",animation:!1,keyboard:!1,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",resolve:{items:{isExitAvailable:k.isExitAvailable}}});a.result.then(function(a){console.log(a),b.onToFail()},function(a){})},b.saveResult=function(a,c){var d=a;"PAT"==a&&(d="PAT"),"CNL"==a&&(d="CN"),o.saved!==!0&&(b.sendStep(d,c),b.setMyTurn(!1))},b.WhiteWinEnd=function(a,c){w||(j.PlayFail(),b.endGame("M2",c))},b.BlackWinEnd=function(a,c){w||(j.PlayFail(),b.endGame("M1",c))},b.PatEnd=function(a){w||b.endGame("PAT",a)},b.CancelEnd=function(a){w||b.endGame("CNL",a)},F.brd?(n=F.user1.uid==F.w?1:0,console.log("col",n),m=z.initChessBoard(A,n),o={isMyTurn:!0,lastStep:B,cantRocker:[],myColorConst:1==n?FigureTypes.WHITE:FigureTypes.BLACK},o.myColor=o.myColorConst,z.initFigures(o,b.boardCallback),z.arrangeFigures(F.brd),z.myColor==FigureTypes.BLACK?(b.StartBlack(),q.pause()):(b.StartWhite(),p.resume(),r.resume()),v=0,j.PlayStart()):(b.showEmpty=!0,n=1,m=z.initChessBoard(A,n),o={isMyTurn:!0,lastStep:B,cantRocker:[],myColorConst:FigureTypes.WHITE},z.initFigures(o,b.boardCallback),z.arrangeFigures("600,1600,2600,3600,4600,5600,6600,7600,701,1702,2703,3704,4705,5703,6702,7701,100,1100,2100,3100,4100,5100,6100,7100,1,1002,2003,3004,4005,5003,6002,7001")),g.mode="playground",b.view_letters=[],b.view_numbers=[],0==n?(b.view_letters=z.letters.slice().reverse(),b.view_numbers=z.numbers):(b.view_letters=z.letters,b.view_numbers=z.numbers.slice().reverse()),b.cells=m,setTimeout(window.onresize,200),b.$on("reporterror",function(a,c){console.log("reporterror"),c.timer1=b.tmrUser1,c.timer2=b.tmrUser2,i.addReport(F.user1.uid,F.bid,JSON.stringify(c))})}]),angular.module("siteApp").service("boardService",function(){}),angular.module("siteApp").controller("ConvertModalCtrl",["$scope","items","$log","$uibModalInstance",function(a,b,c,d){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.title=b.title;var e=b.data,f=new BaseFigure;f.init(e.color,FigureTypes.LADIA);var g=new BaseFigure;g.init(e.color,FigureTypes.KON);var h=new BaseFigure;h.init(e.color,FigureTypes.SLON);var i=new BaseFigure;i.init(e.color,FigureTypes.QUEEN),a.figs=[f,g,h,i],a.selected=null,a.figClick=function(b){f.selected=g.selected=h.selected=i.selected=!1,b.selected=!0,a.selected=b.figType},a.onConvert=function(){d.close({data:e,selected:a.selected})}}]),angular.module("siteApp").controller("EndModalCtrl",["items","$scope","$rootScope","$uibModalInstance",function(a,b,c,d){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],b.result=a.result,b.resultInfo=a.resultInfo,b.res_code=a.res_code,b.endgameInfo=null,a.callback.results=function(d){b.endgameInfo=d,a.user1.uid==d.w?(b.user1.rate=d.rw,b.user1.pos=d.posw,b.user2.rate=d.rb,b.user2.pos=d.posb,b.user1.drate=d.rw-a.user1.rate,b.user2.drate=d.rb-a.user2.rate,b.user1.dpos=d.posw-a.user1.pos,b.user2.dpos=d.posb-a.user2.pos,c.myuser.rate=d.rw,c.myuser.pos=d.posw):(b.user2.rate=d.rw,b.user2.pos=d.posw,b.user1.rate=d.rb,b.user1.pos=d.posb,b.user1.drate=d.rb-a.user1.rate,b.user2.drate=d.rw-a.user2.rate,b.user1.dpos=d.posb-a.user1.pos,b.user2.dpos=d.posw-a.user2.pos,c.myuser.rate=d.rb,c.myuser.pos=d.posb)},b.user1={rate:0,pos:0,drate:0,dpos:0,first_name:a.user1.first_name,last_name:a.user1.last_name,photo:a.user1.photo},b.user2={rate:0,pos:0,drate:0,dpos:0,first_name:a.user2.first_name,last_name:a.user2.last_name,photo:a.user2.photo},b.sendReport=function(){b.endgameInfo.msg=b.textbox,b.$root.$broadcast("reporterror",b.endgameInfo)},b.onClose=function(){d.close({})}}]),angular.module("siteApp").service("AuthService",["$cookies",function(a){this.user=null,this.saveAuthInfo=function(b){this.user=b,a.put("user",JSON.stringify(b))},this.getAuthInfo=function(b){if(this.user)return this.user;var c=a.get("user");try{var b=JSON.parse(c);return b?b:null}catch(d){return null}}}]),angular.module("siteApp").controller("ConfirmgameexitCtrl",["$scope","$uibModalInstance","items",function(a,b,c){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.title="Внимание",a.isExitAvailable=c.isExitAvailable,a.onOk=function(){b.close(!0)},a.onCancel=function(){b.dismiss("cancel")}}]),angular.module("siteApp").service("Options",function(){function a(a){f.volume=a,localStorage.setItem("vchess-options",JSON.stringify(f))}function b(a){f.sound=a,localStorage.setItem("vchess-options",JSON.stringify(f))}function c(a){f=a,localStorage.setItem("vchess-options",JSON.stringify(f))}function d(){return f}function e(){return f.sound}var f,g={sound:!0,volume:90},h=localStorage.getItem("vchess-options");return f=h?JSON.parse(h):g,{setVolume:a,setSound:b,setOptions:c,getOptions:d,soundEnabled:e}}),angular.module("siteApp").service("SoundManager",["Options",function(a){function b(b){a.soundEnabled()&&q[b].play()}function c(a){for(var b=0;b<q.length;b++)q[b].volume=a/100}function d(){b(j),setTimeout(b,1e3,j)}function e(){b(l)}function f(){b(j)}function g(){b(k)}function h(){b(i)}var i=0,j=1,k=2,l=3,m=new Audio("sounds/Tap_on_.mp3"),n=new Audio("sounds/fail_2.mp3"),o=new Audio("sounds/step1_4.mp3"),p=new Audio("sounds/step2_4.mp3"),q=[n,o,p,m];return{PlayStart:d,setVolume:c,PlayTap:e,PlayStep1:f,PlayStep2:g,PlayFail:h}}]),angular.module("siteApp").controller("TermsCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("siteApp").run(["$templateCache",function(a){"use strict";a.put("views/about.html",'<div class="row"> <ul> <li>{{gameResult}}</li> <li>{{comment}}</li> </ul> </div> <div class="row"> <div class="col-sm-3" style="overflow-y: scroll;; height:410px"> <ul class="list-unstyled"> <li ng-repeat="report in reports " ng-click="readReport(report)"> <span ng-class="report.i == cur?\'text-danger \':\'\'">{{report.date_str}}</span> </li> </ul> </div> <button ng-click="nextStep()">next</button> <div class="col-sm-2" style="overflow-y: scroll; height:410px"> <div ng-repeat="step in steps track by $index" ng-click="drawStep($index)"> <div ng-class="curStep == $index? \'selected\':\'\'">{{step.num}} -{{step.num%2}}</div> </div> </div> <div class="col-sm-7"> <div class="row"> {{from}}: {{trw}} - {{trb}} | {{res}} | {{resinfo}} </div> <div class="ch sm"> <div ng-repeat="cellRow in cells track by $index" class="ch-row"> <div ng-bind="view_numbers[$index]" class="letters"> </div> <div ng-repeat="cell in cellRow " class="cell"> <div ng-class="[{true:\'w\',false:\'b\'}[cell.col==1], {true:\'selected\',false:\'\'}[cell.isBlue]]" ng-click="clickCell(cell)"><!--<span ng-bind="cell.name"></span>--> <div class="cell-container" ng-bind-html="cell.fig"> <img ng-show="cell.fig" src="{{cell.fig.img}}"> </div> </div> </div> <div ng-bind="view_numbers[$index]" class="letters"> </div> </div> </div> <table class="ch"> <tr ng-repeat="cellRow in cells"> <td ng-repeat="cell in cellRow"> <div class="cell" ng-class="cell.col==0?\'b\':\'w\'" ng-bind-html="cell.fig"></div> </td> </tr> </table> </div> </div> <div class="row" style="word-wrap: break-word"> <ul> <li>w: <span ng-bind="step.w"> </span></li> <li>b: <span ng-bind="step.b"> </span></li> <li>bid: <span ng-bind="step.bid"> </span></li> <li>from: <span ng-bind="step.from"> </span></li> <li>res: <span ng-bind="step.res"> </span></li> <li>resinfo: <span ng-bind="step.resinfo"> </span> </li> <li>trw: <span ng-bind="step.trw"> </span></li> <li>trb: <span ng-bind="step.trb"> </span></li> <li>sss: <span ng-bind="step.sss"> </span></li> <li>pat: <span ng-bind="step.pat"> </span></li> </ul> {{info}} </div> <div id="chart_reports" style="width: 900px; height: 500px"></div>'),a.put("views/lobby.html",'<!-- <div class="btn" ng-click="testShare()">testShare</div>\n<div class="btn" ng-click="readAch()">readAch()</div>\n<div class="btn" ng-click="createAch()">createAch()</div>\n<div class="btn" ng-click="updateAch()">updateAch()</div>\n<div class="btn" ng-click="deleteAch()">deleteAch()</div>\n<div class="btn" ng-click="postAch()">postAch()</div> --> <div class="row" style="margin-top: 10px"> <div class="col-md-5"> <div class="panel-players panel-content ui-panel-frame"> <div class="players-invites" ng-show="playersInviting.length>0"> <div class="players-invites-title"><span ng-bind="dict_words[\'YouInvited\']"></span>:</div> <div class="scroll-h"> <div ng-repeat="p in playersInviting" class="players-invites-user"> <img src="{{p.photo}}" alt=""> <div ng-click="inviteAgreeOpen(p)" class="btn btn-success btn-xs"><span ng-bind="dict_words[\'invited\']"></span></div> </div> </div> </div> <div class="players-summary"> <span ng-bind="dict_words[\'players_online\']"></span>: <span ng-bind="playerslist.length+1"> </span> </div> <ul class="players list-unstyled" ng-class="{true:\'player-list-with-invites\'}[playersInviting.length>0]"> <li ng-repeat="p in playerslist" class="player-list-item"> <div class="content"> <div class="item-aside"> <img src="{{p.photo}}" class="player-item-photo"> </div> <div class="item-content"> <div class="player-name"> <span ng-bind="p.first_name"></span> <span ng-bind="p.last_name"></span> </div> <div class="icon-text"> <img class="score-icon" src="images/star_line_2.png"> <span ng-bind="p.rate"></span> </div> <div class="icon-text"> <img class="score-icon" src="images/place_2.png"> <span ng-bind="p.pos"> 0</span></div> </div> <div class="btn-row"> <!-- <img ng-show=" p.toPhoto" src="{{p.toPhoto}}" alt="" style="width:30px; height:30px"/> --> <span ng-show="p.sss!=null">играет...</span> <!-- <span ng-show="p.uid==myuser.invuid">отправлено...</span> --> <!-- <button class="btn btn-sm btn-primary"  ng-show="((p.inv && p.inv.to.indexOf( myuser.uid) ==-1) || !p.inv) && p.st==3 && (!myuser.invuid || myuser.invuid.indexOf(p.uid) ==-1)" ng-click="inviteOpen(p)"><span ng-bind="dict_words[\'invite\']"></span></button>\n							 --> <button class="btn btn-sm btn-primary" ng-show="p.st==3" ng-click="inviteOpen(p)"><span ng-bind="dict_words[\'invite\']"></span></button> <button class="btn btn-sm btn-success" ng-show="(p.inv && p.inv.to.indexOf( myuser.uid) !=-1)  && p.st==3" ng-click="inviteAgreeOpen(p)"><span ng-bind="dict_words[\'invited\']"></span></button> </div> </div> </li> </ul> </div> </div> <div class="col-md-6"> <div class="panel-watch panel-content ui-panel-frame"> <div class=""> <div class="watch-game-header"> <span ng-bind="dict_words[\'Playing\']"></span>: <span ng-bind="playersPlayinglist_length"> </span> <div class="row watch-game-info"> <div class="col-xs-1 col-sm-1 col-md-1" style="padding-left:0"><img src="{{watching.pair[0].photo}}" class="player-watch-item-photo"></div> <div class="col-xs-5 col-sm-5 col-md-5"> <div> <span ng-bind="watching.pair[0].first_name"></span> <span ng-bind="watching.pair[0].last_name"></span> </div> <div class="watch-game-info-color"><span ng-bind="watching.pair[0].color"></span></div> </div> <div class="col-xs-5 col-sm-5 col-md-5 text-right"> <div> <span ng-bind="watching.pair[1].first_name"></span> <span ng-bind="watching.pair[1].last_name"> </span></div> <div class="watch-game-info-color"><span ng-bind="watching.pair[1].color"></span></div> </div> <div class="col-xs-1 col-sm-1 col-md-1" style="padding-right:0"><img src="{{watching.pair[1].photo}}" class="player-watch-item-photo"></div> </div> </div> <div ng-show="watch_res" class="game-res-info"><span ng-bind="watch_res"></span></div> </div> <div class="row" style="margin: 0; margin-top:10px"> <div class="col-table" style="float: left; margin-right: 5px"> <div class="text-centers sm chessboard-container"> <div class="letters-container sm"> <div ng-repeat="letter in view_letters" ng-bind="letter" class="letters-h"> </div> </div> <div class="ch sm"> <div ng-repeat="cellRow in cells track by $index" class="ch-row"> <div ng-bind="view_numbers[$index]" class="letters"> </div> <div ng-repeat="cell in cellRow " class="cell"> <div ng-class="[{true:\'w\',false:\'b\'}[cell.col==1], {true:\'selected\',false:\'\'}[cell.isBlue]]" ng-click="clickCell(cell)"><!--<span ng-bind="cell.name"></span>--> <div class="cell-container"> <img ng-show="cell.fig" src="{{cell.fig.img}}"> </div> </div> </div> <div ng-bind="view_numbers[$index]" class="letters"> </div> </div> </div> <div class="letters-container sm"> <div ng-repeat="letter in view_letters" ng-bind="letter" class="letters-h"> </div> </div> </div> <!-- <div class="" style="height: 35px;padding-top: 5px;">\n						<img src="{{watching.pair[1].photo}}" class="player-watch-item-photo"/>\n						<span ng-bind="watching.pair[1].first_name"></span> <span ng-bind="watching.pair[1].last_name"></div> --> </div> <div class="watch-list-container"> <!-- <div class="text-center" style="height:25px"><span ng-bind="dict_words[\'Playing\']"></span> <span ng-bind="playersPlayinglist.length"></span>:</div> --> <div class="scrollable-v"> <ul class="players list-unstyled"> <li ng-repeat="p in playersPlayinglist" class="watch-list-item" ng-click="watchClick(p)" ng-class="{\'active\':p.active == true}"> <div class="content"> <img src="{{p.pair[0].photo}}" class="player-item-photo"> <img src="{{p.pair[1].photo}}" class="player-item-photo"> </div> <!-- <div ng-show="p.active" class="watch-game-container"><span class="watch-game glyphicon glyphicon-eye-open" aria-hidden="true"></span></div>			\n								<div ng-show="!p.active" class="btn btn-xs btn-primary btn-block" ng-click="watchClick(p)"><span ng-bind="dict_words[\'Watch\']" ></span></div>	 --> </li> </ul> </div> </div> </div> </div> </div> <div class="col-md-1"> <div class="panel-menu ui-panel-frame" style="padding-left: 0;    padding-right: 0"> <ul class="list-unstyled"> <li ng-click="openRates100()"> <img src="images/top-btn.png"> </li> <li ng-click="openRates()"> <img src="images/stat.png"> </li> <li ng-click="openHelp()"> <img src="images/question.png"> </li> <li ng-click="openSoundToggle()"> <img src="{{sound_toggle}}"> </li> <li ng-click="openOptions()"> <img src="images/setup-btn.png"> </li> <!--\n			<li ng-click="openRates100()">\n				<img src="images/fullscr_btn.png">\n			</li>--> </ul> </div> </div> </div> <div class="row" style="margin-top: 10px"> <div class="col-md-6"> <div class="panel-friends panel-content ui-panel-frame"> <div ng-repeat="f in friendsList | orderBy:[\'-callable\',\'-online\']"> <div class="btncall-wrapper" ng-class="{true:\'online\'}[f.online==1]"> <img src="{{f.photo_50}}" class="player-item-photo" ng-click="onFriendReqClick(f)"> <div ng-show="f.callable==true" class="btn btn-xs btn-success btn-call" ng-click="onFriendCallClick(f)"><span ng-bind="dict_words[\'call\']"></span></div> <div ng-show="f.callable==false" class="btn btn-xs btn-primary btn-call" ng-click="onFriendReqClick(f)"><span ng-bind="dict_words[\'call\']"></span></div> </div> </div> </div> </div> <div class="col-md-6" ng-controller="ChatgCtrl"> <div class="panel-chat panel-content ui-panel-frame"> <div id="autoscroll" style="height: 100px;   overflow-y: auto"> <div ng-repeat="message in messages"> <strong><span ng-bind="message.user.first_name"></span> <span ng-bind="message.user.last_name"> :</span></strong> <span ng-bind="message.msg"></span> </div> </div> <form ng-submit="send()"> <div class="input-group"> <input ng-model="textbox" class="form-control input-sm" maxlength="256"> <span class="input-group-btn"> <button type="submit" class="btn btn-sm btn-primary" ng-disabled="!myuser.chat"><span ng-bind="dict_words[\'Send\']"></span></button> </span> </div> </form> </div> </div> </div> <script type="text/ng-template" id="modal/inviteModal.html"><div class="modal-header">\n        <h3 class="modal-title" id="modal-title" ng-bind="vm.title"></h3>\n    </div>\n    <div class="modal-body" id="modal-body" >\n	<div class="row">\n		<div class="col-sm-4 col-md-4">\n			<div class="row" ng-if="!vm.agree">\n				<span><span ng-bind="dict_words[\'InviteMode\']"></span>:</span>\n				<form name="inviteModeForm" class="invite-mode-form">\n					<label>\n						<input type="radio" ng-model="vm.inviteMode" value="multiple">\n						<span ng-bind="dict_words[\'InviteAll\']"></span>\n						<span ng-show="vm.inviteMode == \'multiple\'" class="player-invite-mode-comment"><span ng-bind="dict_words[\'InviteAllComment\']"></span></span>\n					</label><br/>\n					<label>\n						<input type="radio" ng-model="vm.inviteMode" value="single">\n						<span ng-bind="vm.playerName"></span><br>\n						<span ng-show="vm.inviteMode == \'single\'" class="player-invite-mode-comment"><span ng-bind="dict_words[\'InviteTo\']"></span></span>\n					</label><br/>\n				\n				\n				</form>\n			</div>\n			<div class="row" ng-show="(vm.inviteMode == \'single\') ||vm.agree">\n				<div class="col-xs-4 col-md-12">\n						<p>\n							<span ng-if="vm.agree"><span ng-bind="dict_words[\'Player\']"></span>:</span>\n							<div>	<img src="{{vm.player.photo}}" class="player-item-photo"/></div>\n						</p>\n				</div>\n				<div class="col-xs-8">\n					 <p ng-if="vm.agree">\n								<span ng-bind="vm.playerName"></span><br>\n					   </p> \n					   <p><span><span ng-bind="dict_words[\'RatePlace\']"></span>:</span><br>\n						   <span class="icon-text"> \n							   <img  class="score-icon" src="images/star_line_2.png" /> <span ng-bind="vm.player.rate" ></span> \n						   </span>&nbsp;&nbsp;\n						   <span class="icon-text"> \n							   <img  class="score-icon" src="images/place_2.png" /> <span ng-bind="vm.player.pos">  </span> \n						   </span>\n					   </p>\n						   \n					   <p><span><span ng-bind="dict_words[\'Games\']"></span>:</span><br>\n						   <span class="icon-text"> \n							   <span ng-bind="vm.player.wins">  </span> \n						   </span>\n						   <span class="icon-text up-icon" > \n							   <span ng-bind="vm.player.pats">  </span> \n						   </span>\n						   <span class="icon-text down-icon" > \n							   <span ng-bind="vm.player.fails">  </span> \n						   </span>\n					   </p> \n				</div>\n			</div>\n			\n			\n		</div>\n\n		<div class="col-sm-8 col-md-8">\n			<p>\n				<span><span ng-bind="dict_words[\'Game_time\']"></span>:</span>    \n				<div class="btn-toolbar" role="toolbar">\n				  <div class="btn-group"  >\n					  <button type="button" ng-disabled="vm.agree" ng-click="vm.activateTmr(tc_total)" class="btn btn-default" ng-repeat="tc_total in vm.tcTotalItems" ng-bind="tc_total" ng-class="{active : tc_total == vm.tmr}"></button>\n				  </div>\n				  \n				</div>\n			</p>\n			<p>	\n				<span><span ng-bind="dict_words[\'Step_time\']"></span>:</span>  \n				<div class="btn-toolbar" role="toolbar">\n				  \n				  <div class="btn-group"  >\n					  <button type="button" ng-disabled="vm.agree"  ng-click="vm.activateTc(tc_local)" class="btn btn-default" ng-repeat="tc_local in vm.tcLocalItems" ng-bind="tc_local" ng-class="{\'active\' : tc_local == vm.tc}"></button>\n				  </div>\n				</div>\n			</p>\n			<p>	\n				<span><span ng-bind="dict_words[\'Color\']"></span>: </span> \n				<div class="btn-toolbar" role="toolbar">\n					<div class="btn-group"  >\n						  <button type="button" ng-disabled="vm.agree"   ng-click="vm.activateColor(col)" class="btn btn-default" ng-repeat="col in vm.colorItems" ng-bind="col" ng-class="{\'active\' : col == vm.color}"></button>\n					</div>\n				</div>\n			</p>  \n		</div>\n	</div>\n    \n	  \n    </div>\n     <div class="modal-footer">\n      	<button class="btn btn-success" type="button" ng-if="vm.agree" ng-click="vm.onAgree()"><span ng-bind="dict_words[\'Play\']"></span></button>\n		<button ng-show="vm.inviteMode" class="btn btn-primary" type="button" ng-if="!vm.agree" ng-click="vm.onOk()"><span ng-bind="dict_words[\'Invite\']"></span></button>\n		<span ng-show= "!vm.inviteMode && !vm.agree" class="red"><span ng-bind="dict_words[\'ModeNotSelected\']"></span></span>	\n        <button class="btn btn-default" type="button" ng-if="vm.agree" ng-click="vm.onClose()"><span ng-bind="dict_words[\'Rejection\']"></span></button>\n		<button class="btn btn-default" type="button" ng-if="!vm.agree" ng-click="vm.onCancel()"><span ng-bind="dict_words[\'Close\']"></span></button>\n		<button ng-show="!vm.inviteMode && !vm.agree" class="btn btn-primary" type="button" ng-if="!vm.agree" ng-click="vm.inviteMode=\'multiple\'; vm.onOk()"><span ng-bind="dict_words[\'SendToAll\']"></span></button>\n    </div></script> <script type="text/ng-template" id="modal/popupHelp.html"><div class="modal-header">\n		<h3 class="modal-title" ><span ><span ng-bind="dict_words[\'About\']"></span>Помощь</span></h3>\n	</div>\n	<div class="modal-body " style="padding: 0px;">\n		<div class="text-container">\n			<p>\n					Для того чтобы начать партию выберите игрока из списка и нажмите кнопку "пригласить".\n					<button class="btn btn-sm btn-primary"  ><span ng-bind="dict_words[\'invite\']"></span></button>\n					\n			</p>\n			<p>\n					Если в списке вы видите кнопку кнопку "играем?", значит игрок приглашает вас на партию, нажмите ее для того чтобы начать.\n					<button  class="btn btn-sm btn-success"><span ng-bind="dict_words[\'invited\']"></span></button>\n					\n			</p>\n			<p>\n					Чтобы заново открыть это окно нажмите "?" на панили справа.\n			</p>\n			\n			\n		</div>\n	</div>\n	<div class="modal-footer">\n		<button class="btn btn-primary" type="button" ng-click="onCancel()"><span ng-bind="dict_words[\'Close\']"></span></button>\n	</div></script> <script type="text/ng-template" id="modal/popupRates100.html"><div class="modal-header">\n		<h3 class="modal-title" ><span ><span ng-bind="dict_words[\'Top\']"></span>-100</span></h3>\n	</div>\n	<div class="modal-body " style="padding: 0px;">\n		\n		<ul class="list-unstyled text-left top-list">\n			<li ng-repeat="p in list" class="player-list-item">\n				<div class=" ">\n					<div class="row" style="border-bottom: 1px solid #ddd;">\n						<div class="col-xs-2 col-sm-2 col-md-2 text-right">\n							 <div class="">\n								<div class="icon-text">	<img  class="score-icon" src="images/place_2.png" /> <span ng-bind="(p.place+1)">	0</span></div>\n							</div>\n							<!--<img src="{{p.photo}}" class="player-item-photo-top"/>-->\n						</div>\n						\n						<div class="col-xs-7 col-sm-7 col-md-7 item-content">\n							<span ng-bind="p.fname"></span> <span ng-bind="p.lname"></span></span>\n						</div>\n						<div class="col-xs-3 col-sm-3 col-md-3 ">			\n							<div class="icon-text">	<img  class="score-icon" src="images/star_line_2.png" /> <span ng-bind="p.rate" ></span> </div>\n						</div>\n					</div>\n				</div>\n			</li>\n		</ul>\n	</div>\n	<div class="modal-footer">\n		<button class="btn btn-primary" type="button" ng-click="onOk()"><span ng-bind="dict_words[\'Close\']"></span></button>\n		<button class="btn btn-warning" type="button" ng-click="onPublish()" disabled><span ng-bind="dict_words[\'Share\']"></span></button>\n	</div></script> <script type="text/ng-template" id="modal/popupRates.html"><div class="modal-header">\n		<h3 class="modal-title" ><span ng-bind="dict_words[\'Statistics\']"></span></h3>\n	</div>\n	<div class="modal-body" style="padding: 0px;">\n		<div id="chart"></div>\n<!--\n		<ul class="list-unstyled text-left">\n			<li ng-repeat="p in uids_list" class="player-list-item">\n				<div class="content">\n					<div class="col-xs-2 col-sm-2 col-md-2">\n					<div class="icon-text">	<img  class="score-icon" src="images/place_2.png" /> <span ng-bind="p.place">	0</span></div>\n			    		<div class="item-aside">\n			    			<img src="{{p.photo}}" class="player-item-photo">\n			    		</div>\n			    	</div>\n			    	<div class="col-xs-6 col-sm-6 col-md-6 item-content">\n				    		<div>\n				    			<span ng-bind="p"></span><span ng-bind="p.fname"></span> <span ng-bind="p.lname"></span>\n				    		</div>\n				    </div>\n				    <div class="col-xs-4 col-sm-4 col-md-4 ">			\n				    		\n				    		<div class="icon-text">	<img  class="score-icon" src="images/star_line_2.png" /> <span ng-bind="p.rate" ></span> </div>\n			    		\n\n		    		</div>\n			    		\n		    	</div>\n			</li>\n		</ul>-->\n	</div>\n	<div class="btn-group">\n	  <button type="button" class="btn btn-link"  ng-click="onRates(0)"><span ng-bind="dict_words[\'Day\']"></span></button>\n	  <button type="button" class="btn btn-link"  ng-click="onRates(1)"><span ng-bind="dict_words[\'Week\']"></span></button>\n	  <button type="button" class="btn btn-link"  ng-click="onRates(2)"><span ng-bind="dict_words[\'Month\']"></span></button>\n	  \n	  <button type="button" class="btn btn-link"  ng-click="onRatesN(1)"><span ng-bind="dict_words[\'Neighbors\']"></span></button>\n	</div>\n	<div class="modal-footer">\n		<button class="btn btn-primary" type="button" ng-click="onOk()"><span ng-bind="dict_words[\'Close\']"></span></button>\n		<button class="btn btn-warning" type="button" ng-click="onPublish()" disabled ><span ng-bind="dict_words[\'Share\']"></span></button>\n	</div></script>'),
a.put("views/main.html",'<div class="jumbotron"> <h1>\'Allo, \'Allo!</h1> <p class="lead"> <img src="images/yeoman.c582c4d1.png" alt="I\'m Yeoman"><br> Always a pleasure scaffolding your apps. </p> <p><a class="btn btn-lg btn-success" ng-href="#/">Splendid!<span class="glyphicon glyphicon-ok"></span></a></p> </div> <div class="row marketing"> <h4>HTML5 Boilerplate</h4> <p> HTML5 Boilerplate is a professional front-end template for building fast, robust, and adaptable web apps or sites. </p> <h4>Angular</h4> <p> AngularJS is a toolset for building the framework most suited to your application development. </p> <h4>Karma</h4> <p>Spectacular Test Runner for JavaScript.</p> </div>'),a.put("views/playground.html",'<div class="panel-playground"> <div class="row" style="margin-top: 10px"> <div class="playground-row pnl"> <div class="col-md-9" ng-if="!_showEmpty" style="z-index: 1031"> <div class="panel-timer ui-panel-frame"> <div class="panel-check"> <div ng-show="isCheck"><span ng-bind="dict_words[\'Check\']"></span></div> </div> <div class="player-clock"> <img src="{{user1.photo}}" class="player-item-photo"> <div class="text-block"> <div><span>{{user1.first_name}} {{user1.last_name}}</span></div> <div class="clock" ng-bind="tmrUser1"></div> </div> </div> <div class="local-timer"> <div ng-show="isMyTurn" class="local-timer-title"><span ng-bind="dict_words[\'Your_turn\']"></span></div> <div ng-show="isMyTurn"><span ng-bind="dict_words[\'Step_limit\']"></span>: <span class="tmrLocal" ng-bind="tmrLocal"></span></div> <div ng-show="!isMyTurn"><span ng-bind="dict_words[\'wait\']"></span></div> </div> <div class="player-clock right"> <div class="text-block"> <div class="text-right"><span>{{user2.first_name}} {{user2.last_name}}</span></div> <div class="clock" ng-bind="tmrUser2"></div> </div> <img src="{{user2.photo}}" class="player-item-photo"> </div> </div> <div class="ui-panel-frame time-line-wrapper"> <div class="time-line"></div> </div> </div> <div class="col-md-9 ui-panel-frame" style="width: auto" ng-if="_showEmpty"> Пригласите игрока чтобы начать игру </div> <div class="col-md-3 panel-history-header"> <div class="panel-timer ui-panel-frame"> <div class="btn-group pull-right"> <div class="btn btn-pat btn-icon" ng-click="onOfferPat()" ng-show="btnEndVisible"><span ng-bind="dict_words[\'Pat\']"></span></div> <div class="btn btn-pat btn-pat-agree btn-icon" ng-click="onToAgreePat()" ng-show="btnEndAgreeVisible"><span ng-bind="dict_words[\'Pat\']"></span>?</div> <div ng-show="playground.isExitAvailable" class="btn btn-exit-game btn-icon" ng-click="onExitGame()"><span ng-bind="dict_words[\'Exit\']"></span></div> <div ng-show="!playground.isExitAvailable" class="btn btn-exit-game btn-icon" ng-click="onExitGame()"><span ng-bind="dict_words[\'Lose\']"></span></div> </div> </div> </div> </div> </div> <div class="row"> <div class="playground-row pnl"> <div class="col-sm-9 col-md-9 col-eq-h" style="z-index: 1031;margin-bottom: 15px"> <div class="chessboard-wrapper"> <div class="chessboard-container"> <div class="letters-container top ui-panel-color"> <div ng-repeat="letter in view_letters" ng-bind="letter" class="letters-h"> </div> </div> <div class="ch ui-panel-color"> <div ng-repeat="cellRow in cells track by $index" class="ch-row"> <div ng-bind="view_numbers[$index]" class="letters"> </div> <div ng-repeat="cell in cellRow " class="cell"> <div ng-class="[{true:\'w\',false:\'b\'}[cell.col==1], {true:\'selected\',false:\'\'}[cell.isBlue], {true:\'selected_old\',false:\'\'}[cell.oldMarker]]" ng-click="clickCell(cell)"> <!--<span ng-bind="cell.name"></span>--> <div class="cell-container"> <img ng-show="cell.fig" src="{{cell.fig.img}}"> </div> </div> </div> <div ng-bind="view_numbers[$index]" class="letters"> </div> </div> </div> <div class="letters-container bottom ui-panel-color"> <div ng-repeat="letter in view_letters" ng-bind="letter" class="letters-h"> </div> </div> </div> </div> </div> <div class="col-sm-3 col-md-3 col-eq-h" style="padding-bottom: 10px"> <div class="group1 ui-panel-frame pnl"> <div class="panel-history"> <div class="content"> <div class="col-md-6 col-sm-6 col-xs-2" ng-repeat="line in historyList track by $index">{{($index%2==0)?($index/2+1)+\'. \'+line:line}}</div> </div> </div> <div class="panel-taken"> <ul class="list-inline"> <li ng-repeat="fig in taken"><img class="fig-taken" src="{{fig.img}}"> </li> </ul> </div> </div> <div class="panel-chat-local ui-panel-frame pnl" ng-controller="ChatgCtrl"> <div class="text-container"> <div id="autoscroll" style="height: 100px;   overflow-y: auto"> <div ng-repeat="message in messages"> <strong><span ng-bind="message.user.first_name"></span> <span ng-bind="message.user.last_name"> :</span></strong> <span ng-bind="message.msg"></span> </div> </div> </div> <form ng-submit="send()" class="chat-form-local"> <div class="input-group" ng-show="myuser.chat"> <input ng-model="textbox" class="form-control input-sm" maxlength="256"> <span class="input-group-btn" style="top: 1px"> <button type="submit" class="btn btn-xs btn-primary"><span ng-bind="dict_words[\'Send\']"></span></button> </span> </div> </form> </div> </div> </div> </div> </div> <script type="text/ng-template" id="modal/convertModal.html"><div class="modal-header">\n		<h3 class="modal-title" id="modal-title" ng-bind="title"></h3>\n	</div>\n	<div class="modal-body" id="modal-body">\n		<ul class="list-inline text-center">\n			<li ng-repeat="fig in figs" class="fig-convert" ng-class="fig.selected ? \'selected\': \'\'" ng-click="figClick(fig)"> <img src="{{fig.img}}"></li>\n		</ul>\n	</div>\n	<div class="modal-footer">\n\n		<button class="btn btn-default" type="button" ng-show="selected" ng-click="onConvert()">Превратить</button>\n	</div></script> <script type="text/ng-template" id="modal/endModal.html"><div class="modal-header" ng-class="[{true: \'win-header\'}[res_code == 1],{true: \'lost-header\'}[res_code == 0]]">\n		<h3 class="modal-title" id="modal-title" ng-bind="result"></h3>{{result_code}}\n	</div>\n	<div class="modal-body end-game-modal" id="modal-body">\n		<div class="lead"><span class="" ng-bind="resultInfo"></span></div>\n\n		<table class="game-result-table">\n			<thead>\n				<tr>\n					<td></td>\n					<td></td>\n					<td><span ng-bind="dict_words[\'Rate\']"></span></td>\n					<td><span ng-bind="dict_words[\'Pos\']"></span></td>\n				</tr>\n			</thead>\n			<tbody>\n				<tr class="table-line table-line-dark">\n					<td></td>\n					<td></td>\n					<td></td>\n					<td></td>\n				</tr>\n				<tr>\n					<td rowspan="2" width="60" height="60"><img src="{{user1.photo}}" class="player-item-photo"></td>\n					<td><span ng-bind="user1.first_name"></span></td>\n					<td><span ng-show="user1.drate > 0">+</span><span ng-bind="user1.drate"></span></td>\n					<td><span ng-show="user1.dpos > 0">+</span><span ng-bind="user1.dpos"></span></td>\n				</tr>\n				<tr>\n					<td><span ng-bind="user1.last_name"></span></td>\n					<td><span ng-bind="user1.rate"></span></td>\n					<td><span ng-bind="user1.pos"></span></td>\n				</tr>\n				<tr class="table-line table-line-light">\n					<td></td>\n					<td></td>\n					<td></td>\n					<td></td>\n				</tr>\n				<tr height="5">\n					<td></td>\n					<td></td>\n					<td></td>\n					<td></td>\n				</tr>\n				<tr>\n					<td rowspan="2" width="60" height="60"><img src="{{user2.photo}}" class="player-item-photo"></td>\n					<td><span ng-bind="user2.first_name"></span></td>\n					<td><span ng-show="user2.drate > 0">+</span><span ng-bind="user2.drate"></span></td>\n					<td><span ng-show="user2.dpos > 0">+</span><span ng-bind="user2.dpos"></span></td>\n				</tr>\n				<tr>\n					<td><span ng-bind="user2.last_name"></span></td>\n					<td><span ng-bind="user2.rate"></span></td>\n					<td><span ng-bind="user2.pos"></span></td>\n				</tr>\n				<tr class="table-line table-line-dark">\n					<td></td>\n					<td></td>\n					<td></td>\n					<td></td>\n				</tr>\n			</tbody>\n		</table>\n	</div>\n\n	<div class="panel-content" ng-hide="reportBlockHide">\n		<div ng-hide	="reporTitletHide">\n				<span ng-bind="dict_words[\'ClickToReport\']"></span><button type="submit" class="btn btn-xs btn-link" ng-click="reporTitletHide=true; reportVisible=true;"><span ng-bind="dict_words[\'ReportError\']"></span></button>\n				\n		</div>\n		\n		<form ng-submit="send()" class="chat-form-local" ng-show="reportVisible" style="margin-bottom:20px">\n				<span><span ng-bind="dict_words[\'DescribeError\']"></span>: </span>	\n					<div class="input-group">\n						<input ng-model="textbox" class="form-control input-sm" maxlength="256">\n						<span class="input-group-btn" style="    top: 1px;">\n							<button type="submit" class="btn btn-xs btn-primary" ng-click="sendReport(); reportBlockHide = true;"><span ng-bind="dict_words[\'Send\']"></span></button>\n							<button  class="btn btn-xs btn-default" ng-click="reportVisible = false;reporTitletHide = false;"><span ng-bind="dict_words[\'Close\']"></span></button>\n						</span>\n					</div>\n				</form>\n	</div>\n	<div class="modal-footer">\n\n		<button class="btn btn-default" type="button" ng-click="onClose()"><span ng-bind="dict_words[\'Close\']"></span></button>\n	</div></script> <script type="text/ng-template" id="modal/confirmPatGameModal.html"><div class="small-modal modal-body " id="">\n		<span ng-bind="dict_words[\'OfferPat\']"></span>?\n\n	</div>\n	<div class="modal-footer">\n		<button class="btn btn-primary" type="button" ng-click="onOk()"><span ng-bind="dict_words[\'Yes\']"></span></button>\n		<button class="btn btn-warning" type="button" ng-click="onCancel()"><span ng-bind="dict_words[\'Close\']"></span></button>\n	</div></script> <script type="text/ng-template" id="modal/confirmEndGameModal.html"><div class="small-modal modal-body" id="">\n\n		<span ng-show="!isExitAvailable"><span ng-bind="dict_words[\'GiveUp\']"></span>?	</span>\n		<span ng-show="isExitAvailable"><span><span ng-bind="dict_words[\'ExitGameText\']"></span></span></span>\n	</div>\n	<div class="modal-footer">\n		<button class="btn btn-primary" type="button" ng-click="onOk()"><span ng-bind="dict_words[\'Yes\']"></span></button>\n		<button class="btn btn-warning" type="button" ng-click="onCancel()"><span ng-bind="dict_words[\'Cancel\']"></span></button>\n	</div></script>'),a.put("views/socket.html",""),a.put("views/terms.html","<p>Terms and Privacy Policy</p> <p> </p><p>Vchess is a platform to play chess online with other people.</p> <p>App collects your name (first name and last name) and a profile picture to create your public player account, introduce you in players list and represent your achivements in game.</p> <p>App does not need your address, email or phone number information and not collecting this data.</p> <p>App may use your frinends list to help you invite frinds in a game it is shown in browser whithout being stored or shared elsewhere. </p> <p>App may ask your permission to let you share your achivements in your timeline. </p> Modified on 12/09/2017. "),a.put("views/tours.html",'<div class="col-md-6"> <label class="form-group">Title:</label> <input type="text" name="" class="form-group form-control" ng-model="title"> <div class="form-group row"> <label class="col-md-2">Start:</label> <div class="col-md-5"> <p class="input-group"> <input type="text" class="form-control" uib-datepicker-popup="{{format}}" ng-model="dt" is-open="popup1.opened" datepicker-options="dateOptions" ng-required="true" close-text="Close" alt-input-formats="altInputFormats"> <span class="input-group-btn"> <button type="button" class="btn btn-default" ng-click="open1()"><i class="glyphicon glyphicon-calendar"></i></button> </span> </p> </div> <div class="col-md-5"> <div style="width:40%; display: inline-block"> <select class="form-control" ng-options="value for value in hours" ng-model="startHour" style="padding: 6px 6px"> </select> </div> <div style="display: inline-block">:</div> <div style="width:40% ; display: inline-block"> <select class="form-control" ng-options="value for value in minutes" ng-model="startMinutes" style="padding: 6px 6px"> </select> </div> </div> </div> <div class="form-group row"> <label class="col-md-2">End:</label> <div class="col-md-5"> <p class="input-group"> <input type="text" class="form-control" uib-datepicker-popup="{{format}}" ng-model="dt2" is-open="popup2.opened" datepicker-options="dateOptions" ng-required="true" close-text="Close" alt-input-formats="altInputFormats"> <span class="input-group-btn"> <button type="button" class="btn btn-default" ng-click="open2()"><i class="glyphicon glyphicon-calendar"></i></button> </span> </p> </div> <div class="col-md-5"> <div style="width:40%; display: inline-block"> <select class="form-control" ng-options="value for value in hours" ng-model="endHour" style="padding: 6px 6px"> </select> </div> <div style="display: inline-block">:</div> <div style="width:40% ; display: inline-block"> <select class="form-control" ng-options="value for value in minutes" ng-model="endMinutes" style="padding: 6px 6px"> </select> </div> </div> </div> <div class="form-group row"> <div class="col-md-8"> <label class="form-group">Time:</label> <select class="form-control" ng-options="item.label for item in timeControl" ng-model="time" style="padding: 6px 6px"> </select> </div> <div class="col-md-4"> <label class="form-group">Size:</label> <select class="form-control" ng-options="value for value in sizes" ng-model="size" style="padding: 6px 6px"> </select> </div> </div> <div class="form-group row"> <button class="btn" ng-click="addTour()">create</button> </div> </div> <div class="col-md-6"> <ul> <li ng-repeat="tour in tours"> <div>id: <span ng-bind="tour.id"></span></div> <div>title: <span ng-bind="tour.title"></span></div> <div>startTime: <span ng-bind="tour.starttime"></span></div> <div>endTime: <span ng-bind="tour.endtime"></span></div> <div>time: <span ng-bind="tour.time"></span></div> <div>size: <span ng-bind="tour.size"></span></div> <button class="btn" ng-click="deleteTournament(tour.id)">Удалить</button> </li> </ul> </div>')}]);